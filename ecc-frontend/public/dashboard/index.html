<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes ‚Ä¢ ECC</title>
  <link rel="stylesheet" href="../css/estilos.css">
  <link rel="stylesheet" href="../css/loader.css">
</head>

<body>

  <button class="logout-btn" onclick="logout()">Sair</button>
  <br><br>

  <!-- Navega√ß√£o -->
  <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
  <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
  <button class="nav-btn" onclick="goTo('cadastro')">Cadastro</button>
  <button class="nav-btn" onclick="goTo('encontreiro')">Encontreiro</button>
  <!-- <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
  <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>
  <button class="nav-btn" onclick="goTo('inscricoes')">Inscri√ß√µes</button> -->

  <p>Bem-vindo, <strong><span id="user-email"></span></strong></p>

  <!-- Eventos -->
  <div class="card">
    <h2>
      ‚ñ∂ Eventos cadastrados
    </h2>
    <table class="grupo-eventos">
      <thead>
        <tr>
          <th colspan="6"><a href="../eventos">Gerenciar Eventos</a></th>
        </tr>
        <tr>
          <th>Nome</th>
          <th>Local</th>
          <th>Data Inicio</th>
          <th>Capacidade</th>
          <th>Inscri√ß√£o Encontristas</th>
          <th>Inscri√ß√£o Encontreiro</th>
        </tr>
      </thead>
      <tbody id="eventos-list" class="grupo-eventos"></tbody>
    </table>
  </div>

  <!-- Equipes -->
  <div class="card">
    <h2 class="toggle-title" data-id="equipes">
      ‚ñ∂ Equipes cadastrados
    </h2>
    <table class="grupo-equipes" style="display: none;">
      <thead>
        <tr>
          <th colspan="2"><a href="equipes.html">Gerenciar Equipes</a></th>
        </tr>
        <tr>
          <th>Nome</th>
          <th>Descri√ß√£o</th>
        </tr>
      </thead>
      <tbody id="equipes-list" class="grupo-equipes"></tbody>
    </table>
  </div>

  <!-- Cadastros -->
  <div class="card">
    <h2 class="toggle-title" data-id="cadastro">
      ‚ñ∂ Pessoas Cadastradas - Cadastro Geral
    </h2>
    <table class="grupo-cadastro" style="display: none;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Telefone</th>
        </tr>
      </thead>
      <tbody id="cadastro-list"></tbody>
    </table>
  </div>


  <!-- Administradores -->
  <div class="card">
    <h2 class="toggle-title" data-id="pessoas">
      ‚ñ∂ Administradores Cadastrados
    </h2>
    <table class="grupo-pessoas" style="display: none;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Telefone</th>
        </tr>
      </thead>
      <tbody id="pessoas-list"></tbody>
    </table>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/loader.js"></script>
  <script>
    // ====================================
    // üîê Autentica√ß√£o
    // ====================================
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));

    if (!token) {
      window.location.href = "../auth/login.html";
    }
    document.getElementById("user-email").innerText = user?.email ?? "";

    // ====================================
    // üîì Logout
    // ====================================
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "../auth/login.html";
    }

    // ====================================
    // üìå CARREGAR DADOS DO BACKEND
    // ====================================

    async function carregarEventos() {

      const res = await fetch(`${APP_CONFIG.API_BASE_URL}/eventos`, {
        headers: { Authorization: "Bearer " + token }
      });
      const evento_res = await res.json();
      const eventos = evento_res.data;

      const tbody = document.getElementById("eventos-list");
      tbody.innerHTML = "";

      eventos.forEach(e => {
        tbody.innerHTML += `
          <tr>
            <td>
               <a href="#" onclick="abrirEvento('${e.id}')">
                ${e.nome}
              </a>
            </td>
            <td>${e.local}</td>
            <td>${formatarDataBR(e.start_date)}</td>
            <td>${e.capacity ?? "-"}</td>
            <td>${formatarMoedaBR(e.valor_encontreiro) ?? "-"}</td>
            <td>${formatarMoedaBR(e.valor_encontrista) ?? "-"}</td>
          </tr>
        `;
      });
    }

    async function carregarEquipes() {
      const res = await fetch(`${APP_CONFIG.API_BASE_URL}/equipes`, {
        headers: { Authorization: "Bearer " + token }
      });
      const equipes_res = await res.json();
      const equipes = equipes_res.data;

      const tbody = document.getElementById("equipes-list");
      tbody.innerHTML = "";

      equipes.forEach(eq => {
        tbody.innerHTML += `
        <tr>
          <td>${eq.nome}</td>
          <td>${eq.descricao ?? "-"}</td>
        </tr>
      `;
      });
    }

    // async function carregarCoordenadores() {
    //   const res = await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole`, {
    //     headers: { Authorization: "Bearer " + token }
    //   });

    //   const vinculos_res = await res.json();
    //   const vinculos = vinculos_res.data;

    //   const tbody = document.getElementById("lista-coordenadores");
    //   tbody.innerHTML = "";

    //   vinculos
    //     .filter(i => i.is_leader === true)
    //     .forEach(i => {
    //       const p = i.pessoa; // pessoa j√° vem no JSON

    //       tbody.innerHTML += `
    //       <tr>
    //         <td>${p?.nome ?? "-"}</td>
    //         <td>${i?.evento?.nome ?? "-"}</td>
    //         <td>${i?.equipe?.nome ?? "-"}</td>
    //        </tr>
    //     `;
    //     });
    // }

    // async function carregarEncontreiros() {
    //   try {
    //     const res = await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole`, {
    //       headers: { Authorization: "Bearer " + token }
    //     });

    //     const inscricoes_res = await res.json();
    //     const inscricoes = inscricoes_res.data;

    //     const tbody = document.getElementById("lista-encontreiros");
    //     tbody.innerHTML = "";

    //     inscricoes
    //       .filter(i => i.is_leader === false)
    //       .forEach(i => {
    //         const p = i.pessoa; // pessoa j√° vem no JSON

    //         tbody.innerHTML += `
    //       <tr>
    //         <td>${p?.nome ?? "-"}</td>
    //         <td>${i?.evento?.nome ?? "-"}</td>
    //         <td>${i?.equipe?.nome ?? "-"}</td>
    //        </tr>
    //     `;
    //       });

    //   } catch (error) {
    //     console.error("Erro ao carregar encontreiros:", error);
    //   }
    // }

    // async function carregarEncontristas() {
    //   try {
    //     const res = await fetch(`${APP_CONFIG.API_BASE_URL}/encontrista_inscricao`, {
    //       headers: { Authorization: "Bearer " + token }
    //     });

    //     const inscricoes_res = await res.json();
    //     const inscricoes = inscricoes_res.data;

    //     const tbody = document.getElementById("encontristas-list");
    //     tbody.innerHTML = "";

    //     inscricoes
    //       .forEach(i => {
    //         const p = i.pessoa;

    //         tbody.innerHTML += `
    //       <tr>
    //         <td>${i.nome_completo_esposo ?? "-"}</td>
    //         <td>${i.nome_completo_esposo ?? "-"}</td>
    //       </tr>
    //     `;
    //       });

    //   } catch (error) {
    //     console.error("Erro ao carregar encontristas:", error);
    //   }
    // }


    async function carregarPessoas() {
      const res = await fetch(`${APP_CONFIG.API_BASE_URL}/pessoas`, {
        headers: { Authorization: "Bearer " + token }
      });
      const pessoas_res = await res.json();
      const pessoas = pessoas_res.data;

      const tbody = document.getElementById("pessoas-list");
      tbody.innerHTML = "";

      pessoas.forEach(p => {
        tbody.innerHTML += `
        <tr>
          <td>${p.nome}</td>
          <td>${p.email ?? "-"}</td>
          <td>${p.telefone ?? "-"}</td>
        </tr>
      `;
      });
    }


    async function carregarCadastro() {
      const res = await fetch(`${APP_CONFIG.API_BASE_URL}/cadastro`, {
        headers: { Authorization: "Bearer " + token }
      });
      const cadastro_res = await res.json();
      const cadastro = cadastro_res.data;

      const tbody = document.getElementById("cadastro-list");
      tbody.innerHTML = "";

      cadastro.forEach(c => {
        tbody.innerHTML += `
        <tr>
          <td>${c.nome_completo_esposo ?? "-"} <BR> ${c.nome_completo_esposa ?? "-"}</td>
          <td>${c.email_esposo ?? "-"} <br> ${c.email_esposa ?? "-"}</td>
          <td>${c.celular_esposo ?? "-"} <br> ${c.celular_esposa ?? "-"}</td>
        </tr>
      `;
      });
    }

    const formatarMoedaBR = (valor) => {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2,
      }).format(valor);
    };


    const ativarToggle = () => {
      document.querySelectorAll(".toggle-title").forEach(title => {
        title.addEventListener("click", () => {
          const id = title.dataset.id;
          const tabela = document.querySelector(`.grupo-${id}`);

          if (!tabela) return;

          const aberto = tabela.style.display !== "none";
          tabela.style.display = aberto ? "none" : "table";

          // Atualiza √≠cone
          title.textContent = `${aberto ? "‚ñ∂" : "‚ñº"} ${title.textContent.replace(/[‚ñ∂‚ñº]\s*/, "")}`;
        });
      });
    };


    function abrirEvento(eventoId) {
      localStorage.setItem("eventoId", eventoId);
      window.location.href = "../eventos/detalhe/";
    }

    // ====================================
    // ‚ñ∂ INICIALIZAR
    // ====================================
    withLoader(async () => {
      await carregarEventos();
      ativarToggle();
      carregarEquipes();
      // carregarCoordenadores();
      // carregarEncontreiros();
      //carregarEncontristas();
      carregarPessoas();
      carregarCadastro();
      
      localStorage.removeItem("CasalId");
      localStorage.removeItem("eventoId");
    });
  </script>

</body>

</html>