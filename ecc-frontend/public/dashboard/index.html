<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes ‚Ä¢ ECC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="../css/estilos.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <link rel="stylesheet" href="../css/media-queries.css">
  <link rel="stylesheet" href="../css/formularios.css">
  <link rel="stylesheet" href="../css/loader.css">
</head>

<body>

  <!-- Navega√ß√£o -->
  <div id="navbar"></div>

  <h1>Dashboard Geral</h1>

  <!-- ================= EVENTOS ================= -->
  <div class="card" id="card-eventos">
    <h2 onclick="goTo('eventos');" style="cursor: pointer;">Eventos</h2>
    <p id="total-eventos">0</p>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Local</th>
          <th>In√≠cio</th>
          <th>Fim</th>
        </tr>
      </thead>
      <tbody id="lista-eventos"></tbody>
    </table>
  </div>

  <!-- ================= EQUIPES ================= -->
  <div class="card" id="card-equipes">
    <h2 onclick="goTo('equipes');" style="cursor: pointer;">Equipes</h2>
    <p id="total-equipes">0</p>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Descri√ß√£o</th>
        </tr>
      </thead>
      <tbody id="lista-equipes"></tbody>
    </table>
  </div>

  <!-- ================= CADASTROS ================= -->
  <div class="card" id="card-cadastros">
    <h2 onclick="goTo('cadastro');" style="cursor: pointer;">Usu√°rios Cadastrados</h2>
    <p id="total-cadastros">0</p>
    <table>
      <thead>
        <tr>
          <th>Casal</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody id="lista-cadastros"></tbody>
    </table>
  </div>

  <!-- ================= PESSOAS ================= -->
  <div class="card" id="card-pessoas">
    <h2>Pessoas</h2>
    <p id="total-pessoas">0</p>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Perfil</th>
        </tr>
      </thead>
      <tbody id="lista-pessoas"></tbody>
    </table>
  </div>

  <!-- MODAL DE CONFIRMA√á√ÉO -->
  <div class="modal-overlay" id="modalConfirm">
    <div class="modal">
      <p id="modalMessage"></p>
      <div class="modal-actions">
        <button onclick="confirmAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script src="../js/config.js"></script>
  <script src="../js/loader.js"></script>
  <script src="../js/auth-check.js"></script>

  <script type="module">
    import { abrirEvento, carregarDashboard } from "../modules/dashboard.js";
    import { renderNavbar } from "../components/navbar.js";

    renderNavbar({ active: "dashboard" });
    requireAuth();

    //PROTEGE A P√ÅGINA POR PERFIL
    (function protectPage() {
      const user = getCurrentUser();

      if (!user || user.role !== "admin") {
        document.getElementById("card-eventos").style.display = "none";
        document.getElementById("card-equipes").style.display = "none";
        document.getElementById("card-cadastros").style.display = "none";
        document.getElementById("card-pessoas").style.display = "none";

        showConfirm("Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.", () => {
          window.location.href = "/eventos";
        });
      }
    })();


    async function initDashboard() {
      try {
        const {
          eventos,
          equipes,
          cadastros,
          pessoas,
          resumo
        } = await carregarDashboard();

        // üî¢ RESUMO
        document.getElementById("total-eventos").innerText = resumo.totalEventos;
        document.getElementById("total-equipes").innerText = resumo.totalEquipes;
        document.getElementById("total-cadastros").innerText = resumo.totalCadastros;
        document.getElementById("total-pessoas").innerText = resumo.totalPessoas;

        // üìã EVENTOS
        const tbodyEventos = document.getElementById("lista-eventos");
        tbodyEventos.innerHTML = "";
        eventos.forEach(ev => {
          tbodyEventos.innerHTML += `
            <tr>
              <td>${ev.nome}</td>
              <td>${ev.local ?? "-"}</td>
              <td>${ev.start_date ?? "-"}</td>
              <td>${ev.end_date ?? "-"}</td>
            </tr>
          `;
        });

        // üìã EQUIPES
        const tbodyEquipes = document.getElementById("lista-equipes");
        tbodyEquipes.innerHTML = "";
        equipes.forEach(eq => {
          tbodyEquipes.innerHTML += `
            <tr>
              <td>${eq.nome}</td>
              <td>${eq.descricao ?? "-"}</td>
            </tr>
          `;
        });

        // üìã CADASTROS
        const tbodyCadastros = document.getElementById("lista-cadastros");
        tbodyCadastros.innerHTML = "";
        cadastros.forEach(c => {
          tbodyCadastros.innerHTML += `
            <tr>
              <td>${c.nome_completo_esposo} & ${c.nome_completo_esposa}</td>
              <td>${c.email_esposo ?? "-"}</td>
            </tr>
          `;
        });

        // üìã PESSOAS
        const tbodyPessoas = document.getElementById("lista-pessoas");
        tbodyPessoas.innerHTML = "";
        pessoas.forEach(p => {
          tbodyPessoas.innerHTML += `
            <tr>
              <td>${p.nome}</td>
              <td>${p.email ?? "-"}</td>
              <td>${p.role ?? "-"}</td>
              </tr>
          `;
        });

      } catch (err) {
        console.error("Erro ao carregar dashboard:", err);
        alert("Erro ao carregar dashboard.");
      }
    }

    // necess√°rio para onclick no HTML
    window.abrirEvento = abrirEvento;

    withLoader(() => initDashboard());
  </script>

</body>

</html>