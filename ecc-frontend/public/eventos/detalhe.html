<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Gerenciar Equipes • ECC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="../css/estilos.css">
    <link rel="stylesheet" href="../css/navbar.css">
    <link rel="stylesheet" href="../css/media-queries.css">
    <link rel="stylesheet" href="../css/formularios.css">
    <link rel="stylesheet" href="../css/loader.css">
</head>

<body>

    <!-- Navegação -->
    <div id="navbar"></div>

    <h1>Gerenciar Eventos</h1>

    <!-- ================= EQUIPES DO EVENTO ================= -->
    <div class="card" id="card-equipes-do-evento">
        <div class="bloco-header">
            <h2>▶ Equipes do Evento</h2>
            <p id="info-equipes-evento"></p>
        </div>

        <button onclick="abrirModalVincularEquipe()">Vincular Equipe ao Evento</button>
        <br><br>

        <table>
            <thead>
                <tr>
                    <th>Equipe</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="lista-equipes-evento"></tbody>
        </table>
    </div>

    <!-- ================= PESSOAS DO EVENTO ================= -->
    <div class="card">
        <div class="bloco-header">
            <h2>▶ Pessoas do Evento</h2>
            <p id="info-pessoas-evento"></p>
        </div>

        <button onclick="abrirModalVincularPessoa()">Vincular Pessoa ao Evento</button>
        <br><br>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Equipe</th>
                    <th>Função</th>
                    <th>Pago</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="lista-pessoas-evento"></tbody>
        </table>
    </div>


    <!-- ================= MODAL VINCULAR / EDITAR EQUIPE  ================= -->
    <div id="modal-vincular-equipe" class="card-modal-overlay" style="display:none;">
        <div class="card">
            <h2>Criar/Atualizar Vínculos</h2>

            <!-- SELECIONAR TODOS -->
            <div>
                <label>Equipes:</label>
                <label class="checkbox-item checkbox-select-all">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    <span>Selecionar todos</span>
                </label>
                <div id="checkboxContainer" class="checkbox-grid"></div>
            </div>

            <div class="modal-actions">
                <button onclick="fecharModal()">Cancelar</button>
                <button onclick="salvarVinculosEquipeEvento()">Salvar</button>
            </div>
        </div>
    </div>


    <!-- ================= MODAL VINCULAR / EDITAR PESSOA ================= -->
    <div id="modal-vincular-pessoa" class="card-modal-overlay" style="display:none;">
        <div class="card">
            <h2 class="modal-title">Vincular Pessoa ao Evento</h2>
            <div class="form-group">
                <label>Casal:</label>
                <select id="cadastro_id" required></select>
            </div>

            <div class="form-group">
                <label>Equipe:</label>
                <select id="equipe_id" required></select>
            </div>

            <div class="form-group">
                <label>Função:</label>
                <select id="regra" required>
                    <option value="encontreiro">Encontreiro</option>
                    <option value="coordenador">Coordenador</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="pagou" />
                    Pago
                </label>
            </div>

            <div class="modal-actions">
                <button onclick="fecharModal()">Cancelar</button>
                <button onclick="salvarPessoaEvento()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div class="modal-overlay" id="modalConfirm">
        <div class="modal">
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- ================= SCRIPTS ================= -->
    <script src="../js/config.js"></script>
    <script src="../js/loader.js"></script>
    <script src="../js/auth-check.js"></script>

    <script type="module">
        requireAuth();
        import { renderNavbar } from "../components/navbar.js";
        renderNavbar({ active: "eventos" });
    </script>

    <script>
        const token = localStorage.getItem("token");
        const eventoId = localStorage.getItem("eventoId");
        let pessoaEventoEditandoId = null;


        /* ================= EQUIPES ================= */
        async function carregarEquipesDoEvento() {
            const res = await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, {
                headers: { Authorization: "Bearer " + token }
            });

            const vinculos = (await res.json()).data || [];
            const tbody = document.getElementById("lista-equipes-evento");
            const info = document.getElementById("info-equipes-evento");

            info.innerText = `${vinculos.length} equipe(s) vinculada(s)`;
            tbody.innerHTML = "";

            vinculos.forEach(v => {
                tbody.innerHTML += `
                    <tr>
                        <td>${v.equipe.nome}</td>
                        <td>
                        <button onclick="removerEquipe('${v.id}')">Remover</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function removerEquipe(id) {
            showConfirm("Remover equipe do evento?", async () => {
                await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });
                carregarEquipesDoEvento();
            });
        }

        /* ================= PESSOAS ================= */
        async function carregarPessoasDoEvento() {
            const res = await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole/evento/${eventoId}`, {
                headers: { Authorization: "Bearer " + token }
            });

            const pessoas = (await res.json()).data || [];
            const tbody = document.getElementById("lista-pessoas-evento");
            const info = document.getElementById("info-pessoas-evento");

            info.innerText = `${pessoas.length} pessoa(s) no evento`;
            tbody.innerHTML = "";

            pessoas.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.cadastro?.nome_completo_esposo ?? "-"} <br> ${p.cadastro?.nome_completo_esposa ?? "-"}</td>
                        <td>${p.equipe?.nome ?? "-"}</td>
                        <td>${p.is_leader ? "Coordenador" : "Encontreiro"}</td>
                        <td>
                            ${p.pagou
                        ? `<span class="badge badge-success">Pago</span>`
                        : `
                                <span class="badge badge-danger">Não</span>
                                <button
                                    class="btn-pagamento"
                                    onclick="gerarPagamento('${p.id}')"
                                >
                                    Gerar Pagamento
                                </button>
                                `
                    }
                            </td>
                        <td>
                        <button onclick="editarPessoaEvento('${p.id}')">Editar</button>
                        <button onclick="removerPessoaEvento('${p.id}', '${p.cadastro?.email_esposo}', '${p.cadastro?.email_esposa}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function abrirModalVincularEquipe() {
            await carregarSelects();

            const modal = document.getElementById("modal-vincular-equipe");
            modal.style.display = "flex";

            await carregarDadosVinculoEquipe();
            let equipesVinculadasOriginais = [];


        }
        async function abrirModalVincularPessoa() {
            pessoaEventoEditandoId = null;
            document.getElementById("modal-vincular-pessoa").style.display = "flex";
            document.getElementById("cadastro_id").disabled = false;
            document.getElementById("pagou").checked = false;
            await carregarSelects();
        }

        function fecharModal() {
            document.getElementById("modal-vincular-pessoa").style.display = "none";
            document.getElementById("modal-vincular-equipe").style.display = "none";
        }

        async function carregarSelects() {
            const [cadastrosRes, equipesRes] = await Promise.all([
                fetch(`${APP_CONFIG.API_BASE_URL}/cadastro`, { headers: { Authorization: "Bearer " + token } }),
                fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, { headers: { Authorization: "Bearer " + token } })
            ]);

            const cadastros = (await cadastrosRes.json()).data || [];
            const equipes = (await equipesRes.json()).data || [];

            const cadastroSelect = document.getElementById("cadastro_id");
            const equipeSelect = document.getElementById("equipe_id");


            cadastroSelect.innerHTML = `<option value="">Selecione</option>`;
            equipeSelect.innerHTML = `<option value="">Selecione</option>`;

            cadastros.forEach(c => {
                cadastroSelect.innerHTML += `<option value="${c.id}">${c.nome_completo_esposo} e ${c.nome_completo_esposa}</option>`;
            });

            equipes.forEach(e => {
                equipeSelect.innerHTML += `<option value="${e.equipe.id}">${e.equipe.nome}</option>`;
            });
        }

        async function salvarPessoaEvento() {
            const regra = document.getElementById("regra").value;

            const payload = {
                evento_id: eventoId,
                cadastro_id: document.getElementById("cadastro_id").value,
                equipe_id: document.getElementById("equipe_id").value,
                is_leader: regra === "coordenador",
                pagou: document.getElementById("pagou").checked
            };

            if (payload.is_leader) {
                payload.role = "coordenador";
            } else {
                payload.role = "user";
            };

            // Buscar cadastro
            const cadastroRes = await fetch(
                `${APP_CONFIG.API_BASE_URL}/cadastro/${payload.cadastro_id}`,
                { headers: { Authorization: "Bearer " + token } }
            );
            if (!cadastroRes.ok) {
                showToast("Erro ao buscar cadastro.");
                return;
            }
            const cadastro = (await cadastroRes.json()).data;

            if (!payload.cadastro_id || !payload.equipe_id) {
                showToast("Preencha todos os campos.");
                return;
            }

            const url = pessoaEventoEditandoId
                ? `${APP_CONFIG.API_BASE_URL}/teamrole/${pessoaEventoEditandoId}`
                : `${APP_CONFIG.API_BASE_URL}/teamrole`;

            const method = pessoaEventoEditandoId ? "PUT" : "POST";

            await fetch(url, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify(payload)
            });



            // Buscar Pessoa
            const pessoaRes = await fetch(
                `${APP_CONFIG.API_BASE_URL}/pessoas/email/${cadastro.email_esposo}`,
                { headers: { Authorization: "Bearer " + token } }
            );
            if (!pessoaRes.ok) {
                showToast("Erro ao buscar pessoa.");

            }
            const pessoa = (await pessoaRes.json()).data;

            const methodPessoa = pessoa.email ? "PUT" : "POST";

            // Criar pessoa ESPOSO
            const pessoaPayload_esposo = {
                nome: cadastro.nome_completo_esposo,
                email: cadastro.email_esposo,
                telefone: cadastro.celular_esposo,
                password: "123456",
                role: payload.role
            };
            const pessoaRes_esposo = await fetch(
                `${APP_CONFIG.API_BASE_URL}/auth/register`,
                {
                    method: methodPessoa,
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify(pessoaPayload_esposo)
                }
            );
            const pessoaJson_esposo = await pessoaRes_esposo.json();

            // Criar pessoa ESPOSA
            const pessoaPayload_esposa = {
                nome: cadastro.nome_completo_esposa,
                email: cadastro.email_esposa,
                telefone: cadastro.celular_esposa,
                password: "123456",
                role: payload.role
            };
            const pessoaRes_esposa = await fetch(
                `${APP_CONFIG.API_BASE_URL}/auth/register`,
                {
                    method: methodPessoa,
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify(pessoaPayload_esposa)
                }
            );
            const pessoaJson_esposa = await pessoaRes_esposa.json();
            fecharModal();
            carregarPessoasDoEvento();
        }

        async function editarPessoaEvento(id) {
            pessoaEventoEditandoId = id;

            const res = await fetch(
                `${APP_CONFIG.API_BASE_URL}/teamrole/${id}`,
                { headers: { Authorization: "Bearer " + token } }
            );

            const json = await res.json();
            const v = json.data;

            await carregarSelects();

            document.getElementById("cadastro_id").value = v.cadastro.id;
            document.getElementById("cadastro_id").disabled = true;
            document.getElementById("equipe_id").value = v.equipe.id;
            document.getElementById("regra").value = v.is_leader ? "coordenador" : "encontreiro";
            document.getElementById("pagou").checked = !!v.pagou;
            document.getElementById("modal-vincular-pessoa").style.display = "flex";
        }

        async function removerPessoaEvento(id, email_esposo, email_esposa) {
            showConfirm("Remover pessoa do evento?", async () => {
                await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });

                await fetch(`${APP_CONFIG.API_BASE_URL}/pessoas/email/${email_esposo}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });

                await fetch(`${APP_CONFIG.API_BASE_URL}/pessoas/email/${email_esposa}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });
                carregarPessoasDoEvento();
            });
        }

        async function gerarPagamento(teamroleId) {
            showConfirm("Gerar pagamento PIX?", async () => {

                withLoader(async () => {
                    try {
                        const res = await fetch(`${APP_CONFIG.API_BASE_URL}/pagamento/encontreiro/${teamroleId}`, {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({}) // ensure body exists
                        });

                        const json = await res.json();

                        if (!res.ok) {
                            alert(json.error || "Erro ao gerar pagamento");
                            return;
                        }

                        const { payment_id } = json;

                        // Redireciona para página que exibe QR Code (abre em nova aba)
                        console.log(window.location.origin);
                        window.open(`${window.location.origin}/eventos/detalhe/pagamento.html?teamrole_id=${teamroleId}&payment_id=${payment_id}`, '_blank');

                    } catch (err) {
                        alert("Erro ao gerar pagamento.");
                        console.error(err);
                    }
                });
            });
        }

        let equipesTodas = [];
        let vinculosEvento = [];

        async function carregarDadosVinculoEquipe() {
            const [equipesRes, vinculosRes] = await Promise.all([
                fetch(`${APP_CONFIG.API_BASE_URL}/equipes`, {
                    headers: { Authorization: "Bearer " + token }
                }),
                fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, {
                    headers: { Authorization: "Bearer " + token }
                })
            ]);

            equipesTodas = (await equipesRes.json()).data || [];
            vinculosEvento = (await vinculosRes.json()).data || [];

            // snapshot do estado inicial
            equipesVinculadasOriginais = vinculosEvento.map(v => v.equipe.id);

            renderizarCheckboxesVinculo();
        }


        function renderizarCheckboxesVinculo() {
            const container = document.getElementById("checkboxContainer");
            const selectAll = document.getElementById("selectAll");

            container.innerHTML = "";
            selectAll.checked = false;

            const equipesVinculadasIds = vinculosEvento.map(v => v.equipe.id);

            equipesTodas.forEach(eq => {
                const checked = equipesVinculadasIds.includes(eq.id) ? "checked" : "";

                container.innerHTML += `
            <label class="checkbox-item">
                <input
                    type="checkbox"
                    value="${eq.id}"
                    ${checked}
                    onchange="syncSelectAll()"
                >
                <span>${eq.nome}</span>
            </label>
        `;
            });

            syncSelectAll();
        }

        function syncSelectAll() {
            const checkboxes = document.querySelectorAll('#checkboxContainer input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            document.getElementById("selectAll").checked = allChecked;
        }

        function toggleSelectAll(master) {
            const checkboxes = document.querySelectorAll('#checkboxContainer input[type="checkbox"]');

            checkboxes.forEach(cb => {
                const equipeId = cb.value;

                if (master.checked) {
                    // Marcar todos
                    cb.checked = true;
                } else {
                    //  Desmarcar apenas os que NÃO eram originais
                    if (!equipesVinculadasOriginais.includes(equipeId)) {
                        cb.checked = false;
                    }
                }
            });

            syncSelectAll();
        }

        // Sincronizar estado do selectAll
        function syncSelectAll() {
            const checkboxes = document.querySelectorAll('#checkboxContainer input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            document.getElementById("selectAll").checked = allChecked;
        }

        async function salvarVinculosEquipeEvento() {
            const checkboxes = document.querySelectorAll('#checkboxContainer input[type="checkbox"]');

            // Estado atual selecionado
            const selecionadasAgora = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Estado original
            const vinculadasAntes = equipesVinculadasOriginais;

            // Diferenças
            const paraCriar = selecionadasAgora.filter(
                id => !vinculadasAntes.includes(id)
            );

            const paraRemover = vinculadasAntes.filter(
                id => !selecionadasAgora.includes(id)
            );

            try {
                withLoader(async () => {

                    // ➕ Criar novos vínculos
                    for (const equipeId of paraCriar) {
                        await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: "Bearer " + token
                            },
                            body: JSON.stringify({
                                evento_id: eventoId,
                                equipe_id: equipeId
                            })
                        });
                    }

                    // ➖ Remover vínculos
                    for (const equipeId of paraRemover) {
                        const vinculo = vinculosEvento.find(
                            v => v.equipe.id === equipeId
                        );

                        if (vinculo) {
                            await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/${vinculo.id}`, {
                                method: "DELETE",
                                headers: {
                                    Authorization: "Bearer " + token
                                }
                            });
                        }
                    }

                    // UI
                    fecharModal();
                    carregarEquipesDoEvento();
                    showToast("Vínculos atualizados com sucesso.");
                });

            } catch (err) {
                console.error(err);
                showToast("Erro ao salvar vínculos.");
            }
        }

        window.removerEquipe = removerEquipe;
        window.abrirModalVincularPessoa = abrirModalVincularPessoa;
        // window.fecharModalVincularPessoa = fecharModalVincularPessoa;
        window.salvarPessoaEvento = salvarPessoaEvento;
        window.editarPessoaEvento = editarPessoaEvento;
        window.removerPessoaEvento = removerPessoaEvento;

        window.gerarPagamento = gerarPagamento;

        carregarEquipesDoEvento();
        carregarPessoasDoEvento();
    </script>

</body>

</html>