<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Evento • ECC</title>

    <link rel="stylesheet" href="../../css/estilos.css">
    <link rel="stylesheet" href="../../css/loader.css">
</head>

<body>

    <button onclick="voltar()"> ← Voltar</button>

    <h1 id="evento-nome">Carregando evento...</h1>

    <!-- Eventos -->
    <div class="card">
        <h2 class="toggle-title" data-id="eventos">
            ▶ Equipes do Evento
        </h2>
        <table class="grupo-eventos">
            <thead>
                <tr>
                    <th>Nome da Equipe</th>
                    <th>Descrição da Equipe</th>
                </tr>
            </thead>
            <tbody id="equipes-evento-lista"></tbody>
        </table>
        <p id="equipes-vazio" style="display:none;">
            Nenhuma equipe vinculada a este evento.
        </p>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2> ▶ Pessoas do Evento</h2>
            <a href="./pessoas.html">Gerenciar pessoas</a>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Telefone</th>
                    <th>Equipe</th>
                    <th>Regras</th>
                    <th>Pagou?</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="pessoas-evento-lista"></tbody>
        </table>

        <p id="pessoas-vazio" style="display:none;">
            Nenhuma pessoa vinculada a este evento.
        </p>
    </div>

    <div class="card" >
        <h2> ▶ Gestão do Evento</h2>

        <ul id="gestao-evento">
        </ul>
    </div>

    <!-- Edição -->
    <div class="card" id="card-editar" style="display:none;">
        <h2>Editar Encontreiro</h2>
        <form id="form-edicao">
            <input type="hidden" id="team-role-Em-Edicao-Id">
            <input type="hidden" id="team-role-Id">

            <div id="bloco-regras" style="display: none;">
                <span> Regras de vínculo para: </span>
                <span id="nome-regra-vinculo"></span>

                <span>Equipe Atual: </span>
                <span id="nome-equipe-atual"></span>

                <div>
                    <select id="edit_equipe_id">
                        <option value="">Selecione um equipe primeiro</option>
                    </select>
                </div>
                <div>
                    <label class="checkbox-item"> Coordenador / Líder
                        <input id="edit_is_leader" type="checkbox" />
                    </label>

                    <label class="checkbox-item"> Pagou
                        <input id="edit_pagou" type="checkbox" />
                    </label>
                </div>
            </div>

            <div class="actions">
                <button type="button" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
                <button type="submit">Salvar alterações</button>
            </div>
        </form>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div class="modal-overlay" id="modalConfirm">
        <div class="modal">
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="../../js/config.js"></script>
    <script src="../../js/loader.js"></script>

    <script>
        const token = localStorage.getItem("token");
        const eventoId = localStorage.getItem("eventoId");

        const API = APP_CONFIG.API_BASE_URL;

        const API_PESSOAS = API + "/pessoas";
        const API_EVENTOS = API + "/eventos";
        const API_EQUIPES_EVENTO = API + "/eventos";
        const API_TEAMROLE = API + "/teamrole";

        // =====================================
        // ELEMENTOS
        // =====================================
        const card = document.getElementById("card");
        const tbodyEncontreiro = document.getElementById("tbody-encontreiro");
        const blocoRegras = document.getElementById("bloco-regras");
        const formEdicao = document.getElementById("form-edicao");

        // selects edição
        const selectEditEquipe = document.getElementById("edit_equipe_id");

        // Modo de edição
        const EDIT_MODE = { NONE: "none", PESSOA: "pessoa", TEAMROLE: "teamrole" };
        let editMode = EDIT_MODE.NONE;

        if (!token) {
            window.location.href = "../../auth/login.html";
        }

        if (!eventoId) {
            window.location.href = "../index.html";
        }

        function voltar() {
            localStorage.removeItem("eventoId");
            window.location.href = "../../dashboard";
        }

        async function carregarEvento() {
            const res = await fetch(`${APP_CONFIG.API_BASE_URL}/eventos/${eventoId}`, {
                headers: { Authorization: "Bearer " + token }
            });

            const json = await res.json();
            document.getElementById("evento-nome").innerText = json.data.nome;
        }

        async function carregarEquipesEvento() {
            const res = await fetch(
                `${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`,
                { headers: { Authorization: "Bearer " + token } }
            );

            const json = await res.json();
            const lista = json.data || [];

            const tbody = document.getElementById("equipes-evento-lista");
            const vazio = document.getElementById("equipes-vazio");
            const gestaoEvento = document.getElementById("gestao-evento");



            tbody.innerHTML = "";
            
            if (!lista.length) {
                gestaoEvento.innerHTML = `
                        <li><a href="./equipes.html">Equipes</a></li>
                        <li><a href="./pessoas.html">Pessoas</a></li>
                        <li><a href="./inscricoes.html">Inscrições</a></li>
                        <li><a href="./vincularCasal.html">Vincular Casal ao Evento</a></li>`;    
                vazio.style.display = "block";
                return;
            }

            vazio.style.display = "none";

            lista.forEach(item => {
                const eq = item.equipe;
                tbody.innerHTML += `
                    <tr>
                        <td>${eq.nome}</td>
                        <td>${eq.descricao ?? "-"}</td>
                    </tr>
                    `;
            });
        }

        async function carregarPessoasEvento() {
            const tbodyEncontreiro = document.getElementById("pessoas-evento-lista");
            tbodyEncontreiro.innerHTML = "";

            try {
                // Carrega as equipes do evento
                const resEquipes = await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, { headers: { Authorization: "Bearer " + token } });
                const jsonEquipes = await resEquipes.json();
                const equipes = jsonEquipes.data || [];

                // Extrai os IDs das equipes vinculadas ao evento
                const idsEquipes = equipes.map(eq => eq.equipe.id);

                // Carrega as pessoas do evento
                const resPessoas = await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole/evento/${eventoId}`, { headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" } });
                const jsonPessoas = await resPessoas.json();
                const listaPessoas = (jsonPessoas.data || []).filter(tr => tr.pessoa?.role !== "admin");

                // Filtra as pessoas que estão nas equipes vinculadas ao evento
                const pessoasNoEvento = listaPessoas.filter(tr => {
                    return tr.equipe && idsEquipes.includes(tr.equipe.id);
                });

                if (!pessoasNoEvento.length) {
                    document.getElementById("pessoas-vazio").style.display = "block";
                    return;
                }

                // Exibe as pessoas no evento
                tbodyEncontreiro.innerHTML = "";
                pessoasNoEvento.forEach(tr => {
                    tbodyEncontreiro.innerHTML += `
                        <tr>
                            <td><a href="#" onclick="AbrirVinculo('${tr.cadastro?.id}')"> ${tr.cadastro?.nome_completo_esposo || "-"} <br> ${tr.cadastro?.nome_completo_esposa || "-"} </a></td>
                            <td>${tr.cadastro?.email_esposo || "-"} <br> ${tr.cadastro?.email_esposa || "-"}</td>
                            <td>${tr.cadastro?.celular_esposo || "-"} <br> ${tr.cadastro?.celular_esposa || "-"}</td>
                            <td>${tr.equipe?.nome || "-"}</td>
                            <td>
                                <span class="badge ${tr.is_leader ? "blue" : "red"}">
                                ${tr.is_leader ? "Coordenador" : "Encontreiro"}
                                </span>
                            </td>
                            <td>
                                ${tr.pagou ? `SIM` : `NÃO ${tr.evento?.valor_encontreiro}
                                <button onclick="gerarPagamento('${tr.id}', '${tr.pessoa?.nome}')">
                                Gerar Pagamento
                                </button>
                                `}
                            </td>
                            <td>
                                <button class="secondary btn-editar-tr" data-id="${tr.id}" onclick="abrirEdicaoTeamrole('${tr.id}');">Editar</button>
                                <button class="danger btn-excluir-tr" data-id="${tr.id}" onclick="excluirEncontreiroGeral('${tr.id}');">Excluir</button>
                            </td>
                        </tr>
                                `;
                });

            } catch (err) {
                console.error("Erro ao carregar encontreiros inscritos:", err);
                document.getElementById("pessoas-vazio").textContent = "Erro ao carregar.";
            }
        }

        function cancelarEdicao() {
            document.getElementById("form-edicao").reset();
            document.getElementById("card-editar").style.display = "none";
        }

        // =====================================
        // ABRIR EDIÇÃO: TEAMROLE
        // =====================================
        async function abrirEdicaoTeamrole(id) {

            editMode = EDIT_MODE.TEAMROLE;

            document.getElementById("card-editar").style.display = "block";
            document.getElementById("nome-regra-vinculo").style.display = "block";
            blocoRegras.style.display = "block";

            try {
                const res = await fetch(`${API}/teamrole/evento/${eventoId}`, { headers: { Authorization: `Bearer ${token}` } });
                const cadastros = (await res.json()).data;
                const vinculo = cadastros[0];

                teamroleEmEdicaoId = document.getElementById("team-role-Em-Edicao-Id");
                teamroleEmEdicaoId.value = vinculo?.cadastro?.id;

                teamRoleId = document.getElementById("team-role-Id");
                teamRoleId.value = vinculo?.id;

                const nomeRegraVinculo = document.getElementById("nome-regra-vinculo");
                nomeRegraVinculo.innerHTML = `${vinculo?.cadastro?.nome_completo_esposo} e ${vinculo?.cadastro?.nome_completo_esposa}`;

                const nomeEquipeAtual = document.getElementById("nome-equipe-atual");
                nomeEquipeAtual.innerHTML = `${vinculo?.equipe.nome}`;

                const isLeaderCheckbox = document.getElementById("edit_is_leader");
                const pagouCheckbox = document.getElementById("edit_pagou");

                isLeaderCheckbox.checked = vinculo?.is_leader ?? false;
                pagouCheckbox.checked = vinculo?.pagou ?? false;

                selectEditEquipe.innerHTML = `<option value="${vinculo?.equipe.id}" selected> ${vinculo?.equipe.nome} </option> `;
                selectEditEquipe.disabled = true;

                // const tr = json.data;

            } catch (err) {
                alert("Erro ao abrir edição.");
            }
        }

        // ========================================
        // ENVIO DO FORMULARIO DE EDICAO DE VINCULO 
        // ========================================
        formEdicao.addEventListener("submit", async (e) => {
            e.preventDefault();

            const payload = {
                is_leader: document.getElementById("edit_is_leader").checked,
                pagou: document.getElementById("edit_pagou").checked
            };

            try {
                const res = await fetch(`${API}/teamrole/${teamRoleId.value}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Erro ao salvar");

                showToast("Vínculo atualizado com sucesso.");
                cancelarEdicao();
                await carregarPessoasEvento();

            } catch (err) {
                console.error(err);
                showToast("Erro ao salvar alterações.");
            }
        });

        // =====================================
        // EXCLUIR PESSOA
        // =====================================
        async function excluirEncontreiroGeral(id) {
            showConfirm("Tem certeza que deseja excluir este encontreiro?", async () => {
                try {
                    const response = await fetch(`${API}/teamrole/${id}`, {
                        method: "DELETE",
                        headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
                    });
                    if (!response.ok) {
                        showToast("Encontreiro vinculado a uma equipe.");
                        return;
                    }
                    await carregarPessoasEvento();

                    showToast("Encontreiro excluído!");
                } catch (error) {
                    console.error("Erro ao excluir equipe:", error);
                    showToast("Erro ao excluir equipe");
                }
            });
        }

        // =====================================
        // INICIALIZAÇÃO
        // =====================================
        withLoader(() => (async function init() {
            await carregarPessoasEvento();
            await carregarEquipesEvento();
            await carregarEquipesEvento();
            await ativarToggle();
            await carregarEvento();
        })());



    </script>

</body>

</html>