<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Detalhe do Evento ‚Ä¢ ECC</title>

    <link rel="stylesheet" href="../../css/estilos.css">
    <link rel="stylesheet" href="../../css/loader.css">
</head>

<body>

    <!-- üîê Auth -->
    <script src="../../js/auth-check.js"></script>
    <script>
        requireAuth();
    </script>

    <button class="logout-btn" onclick="logout()">Sair</button>
    <br><br>

    <!-- Navega√ß√£o -->
    <button class="nav-btn" onclick="goTo('../dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="goTo('../eventos')">Eventos</button>
    <button class="nav-btn" onclick="goTo('../equipes')">Equipes</button>
    <button class="nav-btn" onclick="goTo('../cadastro')">Cadastro</button>

    <!-- ================= EQUIPES DO EVENTO ================= -->
    <div class="card">
        <div class="bloco-header">
            <h2>‚ñ∂ Equipes do Evento</h2>
            <p id="info-equipes-evento"></p>
        </div>

        <button onclick="abrirModalVincularEquipe()">Vincular Equipe ao Evento</button>
        <br><br>

        <table>
            <thead>
                <tr>
                    <th>Equipe</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-equipes-evento"></tbody>
        </table>
    </div>

    <!-- ================= PESSOAS DO EVENTO ================= -->
    <div class="card">
        <div class="bloco-header">
            <h2>‚ñ∂ Pessoas do Evento</h2>
            <p id="info-pessoas-evento"></p>
        </div>

        <button onclick="abrirModalVincularPessoa()">Vincular Pessoa ao Evento</button>
        <br><br>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Equipe</th>
                    <th>Fun√ß√£o</th>
                    <th>Pago</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-pessoas-evento"></tbody>
        </table>
    </div>

    <!-- ================= MODAL VINCULAR / EDITAR PESSOA ================= -->
    <div id="modal-vincular-pessoa" class="card-modal-overlay" style="display:none;">
        <div class="card">

            <h2 class="modal-title">Vincular Pessoa ao Evento</h2>

            <div class="form-group">
                <label>Casal:</label>
                <select id="cadastro_id" required></select>
            </div>

            <div class="form-group">
                <label>Equipe:</label>
                <select id="equipe_id" required></select>
            </div>

            <div class="form-group">
                <label>Fun√ß√£o:</label>
                <select id="regra" required>
                    <option value="encontreiro">Encontreiro</option>
                    <option value="coordenador">Coordenador</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="pagou" />
                    Pago
                </label>
            </div>

            <div class="modal-actions">
                <button onclick="fecharModalVincularPessoa()">Cancelar</button>
                <button onclick="salvarPessoaEvento()">Salvar</button>
            </div>

        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div class="modal-overlay" id="modalConfirm">
        <div class="modal">
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- ================= SCRIPTS ================= -->
    <script src="../../js/config.js"></script>
    <script src="../../js/loader.js"></script>

    <script type="module">
        const token = localStorage.getItem("token");
        const eventoId = localStorage.getItem("eventoId");
        let pessoaEventoEditandoId = null;

        if (!eventoId) {
            alert("Evento n√£o selecionado.");
            location.href = "../";
        }

        /* ================= EQUIPES ================= */
        async function carregarEquipesDoEvento() {
            const res = await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, {
                headers: { Authorization: "Bearer " + token }
            });

            const vinculos = (await res.json()).data || [];
            const tbody = document.getElementById("lista-equipes-evento");
            const info = document.getElementById("info-equipes-evento");

            info.innerText = `${vinculos.length} equipe(s) vinculada(s)`;
            tbody.innerHTML = "";

            vinculos.forEach(v => {
                tbody.innerHTML += `
                    <tr>
                        <td>${v.equipe.nome}</td>
                        <td>
                        <button onclick="removerEquipe('${v.id}')">Remover</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function removerEquipe(id) {
            showConfirm("Remover equipe do evento?", async () => {
                await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });
                carregarEquipesDoEvento();
            });
        }

        /* ================= PESSOAS ================= */
        async function carregarPessoasDoEvento() {
            const res = await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole/evento/${eventoId}`, {
                headers: { Authorization: "Bearer " + token }
            });

            const pessoas = (await res.json()).data || [];
            const tbody = document.getElementById("lista-pessoas-evento");
            const info = document.getElementById("info-pessoas-evento");

            info.innerText = `${pessoas.length} pessoa(s) no evento`;
            tbody.innerHTML = "";

            pessoas.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.cadastro?.nome_completo_esposo ?? "-"} <br> ${p.cadastro?.nome_completo_esposa ?? "-"}</td>
                        <td>${p.equipe?.nome ?? "-"}</td>
                        <td>${p.is_leader ? "Coordenador" : "Encontreiro"}</td>
                        <td>
                            ${p.pagou
                        ? `<span class="badge badge-success">Pago</span>`
                        : `
                                <span class="badge badge-danger">N√£o</span>
                                <button
                                    class="btn-pagamento"
                                    onclick="gerarPagamento('${p.id}')"
                                >
                                    Gerar Pagamento
                                </button>
                                `
                    }
                            </td>
                        <td>
                        <button onclick="editarPessoaEvento('${p.id}')">Editar</button>
                        <button onclick="removerPessoaEvento('${p.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function abrirModalVincularPessoa() {
            pessoaEventoEditandoId = null;
            document.getElementById("modal-vincular-pessoa").style.display = "flex";
            document.getElementById("cadastro_id").disabled = false;
            document.getElementById("pagou").checked = false;
            await carregarSelects();
        }

        function fecharModalVincularPessoa() {
            document.getElementById("modal-vincular-pessoa").style.display = "none";
        }

        async function carregarSelects() {
            const [cadastrosRes, equipesRes] = await Promise.all([
                fetch(`${APP_CONFIG.API_BASE_URL}/cadastro`, { headers: { Authorization: "Bearer " + token } }),
                fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, { headers: { Authorization: "Bearer " + token } })
            ]);

            const cadastros = (await cadastrosRes.json()).data || [];
            const equipes = (await equipesRes.json()).data || [];

            const cadastroSelect = document.getElementById("cadastro_id");
            const equipeSelect = document.getElementById("equipe_id");

            cadastroSelect.innerHTML = `<option value="">Selecione</option>`;
            equipeSelect.innerHTML = `<option value="">Selecione</option>`;

            cadastros.forEach(c => {
                cadastroSelect.innerHTML += `<option value="${c.id}">${c.nome_completo_esposo} e ${c.nome_completo_esposa}</option>`;
            });

            equipes.forEach(e => {
                equipeSelect.innerHTML += `<option value="${e.equipe.id}">${e.equipe.nome}</option>`;
            });
        }

        async function salvarPessoaEvento() {
            const regra = document.getElementById("regra").value;

            const payload = {
                evento_id: eventoId,
                cadastro_id: document.getElementById("cadastro_id").value,
                equipe_id: document.getElementById("equipe_id").value,
                is_leader: regra === "coordenador",
                pagou: document.getElementById("pagou").checked
            };

            if (!payload.cadastro_id || !payload.equipe_id) {
                showToast("Preencha todos os campos.");
                return;
            }

            const url = pessoaEventoEditandoId
                ? `${APP_CONFIG.API_BASE_URL}/teamrole/${pessoaEventoEditandoId}`
                : `${APP_CONFIG.API_BASE_URL}/teamrole`;

            const method = pessoaEventoEditandoId ? "PUT" : "POST";

            await fetch(url, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify(payload)
            });

            fecharModalVincularPessoa();
            carregarPessoasDoEvento();
        }

        async function editarPessoaEvento(id) {
            pessoaEventoEditandoId = id;

            const res = await fetch(
                `${APP_CONFIG.API_BASE_URL}/teamrole/${id}`,
                { headers: { Authorization: "Bearer " + token } }
            );

            const json = await res.json();
            const v = json.data;

            await carregarSelects();

            document.getElementById("cadastro_id").value = v.cadastro.id;
            document.getElementById("cadastro_id").disabled = true;
            document.getElementById("equipe_id").value = v.equipe.id;
            document.getElementById("regra").value = v.is_leader ? "coordenador" : "encontreiro";
            document.getElementById("pagou").checked = !!v.pagou;
            document.getElementById("modal-vincular-pessoa").style.display = "flex";
        }

        async function removerPessoaEvento(id) {
            showConfirm("Remover pessoa do evento?", async () => {
                await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });
                carregarPessoasDoEvento();
            });
        }

        async function gerarPagamento(teamroleId) {
            showConfirm("Gerar pagamento PIX?", async () => {

                withLoader(async () => {
                    try {
                        const res = await fetch(`${APP_CONFIG.API_BASE_URL}/pagamento/encontreiro/${teamroleId}`, {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({}) // ensure body exists
                        });

                        const json = await res.json();

                        if (!res.ok) {
                            alert(json.error || "Erro ao gerar pagamento");
                            return;
                        }

                        const { payment_id } = json;

                        // Redireciona para p√°gina que exibe QR Code (abre em nova aba)
                        console.log(window.location.origin);
                        window.open(`${window.location.origin}/eventos/detalhe/pagamento.html?teamrole_id=${teamroleId}&payment_id=${payment_id}`, '_blank');

                    } catch (err) {
                        alert("Erro ao gerar pagamento.");
                        console.error(err);
                    }
                });
            });
        }

        window.removerEquipe = removerEquipe;
        window.abrirModalVincularPessoa = abrirModalVincularPessoa;
        window.fecharModalVincularPessoa = fecharModalVincularPessoa;
        window.salvarPessoaEvento = salvarPessoaEvento;
        window.editarPessoaEvento = editarPessoaEvento;
        window.removerPessoaEvento = removerPessoaEvento;

        window.gerarPagamento = gerarPagamento;

        carregarEquipesDoEvento();
        carregarPessoasDoEvento();
    </script>

</body>

</html>