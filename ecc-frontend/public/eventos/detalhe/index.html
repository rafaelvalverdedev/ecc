<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Eventos ‚Ä¢ ECC</title>

    <link rel="stylesheet" href="../../css/estilos.css">
    <link rel="stylesheet" href="../../css/loader.css">
</head>

<body>

    <!-- üîê Auth -->
    <script src="../../js/auth-check.js"></script>
    <script>
        requireAuth();
    </script>

    <button class="logout-btn" onclick="logout()">Sair</button>
    <br><br>

    <!-- Navega√ß√£o -->
    <button class="nav-btn" onclick="goTo('../dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="goTo('../eventos')">Eventos</button>
    <button class="nav-btn" onclick="goTo('../equipes')">Equipes</button>
    <button class="nav-btn" onclick="goTo('../cadastro')">Cadastro</button>
    <button class="nav-btn" onclick="goTo('../pessoas')">Pessoas</button>

    <!-- ================= EQUIPES DO EVENTO ================= -->
    <div class="card">
        <div class="bloco-header">
            <h2>‚ñ∂ Equipes do Evento</h2>
            <p id="info-equipes-evento"></p>
        </div>

        <button onclick="abrirModalVincularEquipe()">
            Vincular Equipe ao Evento
        </button>

        <br><br>

        <table>
            <thead>
                <tr>
                    <th>Nome da Equipe</th>
                    <th>Descri√ß√£o</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-equipes-evento"></tbody>
        </table>
    </div>

    <!-- ================= MODAL VINCULAR EQUIPE ================= -->
    <div id="modal-vincular-equipe" class="card-modal-overlay" style="display:none;">
        <div class="card-modal">
            <h3>Vincular Equipe ao Evento</h3>

            <label>Equipe</label>
            <select id="select-equipe">
                <option value="">Selecione a equipe</option>
            </select>

            <br><br>
            <button onclick="salvarVinculoEquipe()">Salvar</button>
            <button onclick="fecharModalVincularEquipe()">Cancelar</button>
        </div>
    </div>


    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div class="modal-overlay" id="modalConfirm">
        <div class="modal">
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- ================= SCRIPTS ================= -->
    <script src="../../js/config.js"></script>
    <script src="../../js/loader.js"></script>

    <script type="module">
        const eventoId = localStorage.getItem("eventoId");

        if (!eventoId) {
            alert("Nenhum evento selecionado.");
            window.location.href = "../";
        }

        import {
            listarEquipesDoEvento,
            desvincularEquipeDoEvento
        } from "../../modules/equipes-evento.js";
        import { listarEquipes } from "../../modules/equipes.js";
        import { vincularEquipeAoEvento } from "../../modules/equipes-evento.js";

        async function carregarEquipesDoEvento() {
            const vinculos = await listarEquipesDoEvento(eventoId);
            const tbody = document.getElementById("lista-equipes-evento");
            const info = document.getElementById("info-equipes-evento");

            info.innerText = `Evento: ${info.innerText} ${vinculos.length} equipe(s) vinculada(s)`;
            tbody.innerHTML = "";

            vinculos.forEach(v => {
                tbody.innerHTML += `
                    <tr>
                        <td>${v.equipe.nome}</td>
                        <td>${v.equipe.descricao ?? "-"}</td>
                        <td>
                        <button onclick="removerEquipe('${v.id}')">Remover</button>
                        </td>
                    </tr>
                    `;
            });
        }

        async function removerEquipe(vinculoId) {
            showConfirm("Tem certeza que deseja excluir este v√≠nculo?", () => {
                withLoader(async () => {
                    await desvincularEquipeDoEvento(vinculoId);
                });

                carregarEquipesDoEvento();
            });
        }

        function abrirModalVincularEquipe() {
            document.getElementById("modal-vincular-equipe").style.display = "block";
            carregarSelectEquipes();
        }

        function fecharModalVincularEquipe() {
            document.getElementById("modal-vincular-equipe").style.display = "none";
        }

        async function carregarSelectEquipes() {
            const select = document.getElementById("select-equipe");
            select.innerHTML = `<option value="">Selecione a equipe</option>`;

            // todas as equipes
            const equipes = await listarEquipes();

            // equipes j√° vinculadas ao evento
            const vinculos = await listarEquipesDoEvento(eventoId);
            const equipesVinculadasIds = vinculos.map(v => v.equipe.id);

            equipes.forEach(eq => {
                const opt = document.createElement("option");
                opt.value = eq.id;
                opt.textContent = eq.nome;

                // se j√° estiver vinculada, desabilita
                if (equipesVinculadasIds.includes(eq.id)) {
                    opt.disabled = true;
                    opt.textContent += " (j√° vinculada)";
                }

                select.appendChild(opt);
            });
        }

        async function salvarVinculoEquipe() {
            const equipeId = document.getElementById("select-equipe").value;

            if (!equipeId) {
                alert("Selecione uma equipe.");
                return;
            }

            await withLoader(async () => {
                await vincularEquipeAoEvento(eventoId, equipeId);
            });

            fecharModalVincularEquipe();
            carregarEquipesDoEvento();
        }

        window.removerEquipe = removerEquipe;
        window.abrirModalVincularEquipe = abrirModalVincularEquipe;
        window.fecharModalVincularEquipe = fecharModalVincularEquipe;
        window.salvarVinculoEquipe = salvarVinculoEquipe;

        carregarEquipesDoEvento();
    </script>

</body>

</html>