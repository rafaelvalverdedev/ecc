<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Eventos ‚Ä¢ ECC</title>

    <link rel="stylesheet" href="../../css/estilos.css">
    <link rel="stylesheet" href="../../css/loader.css">
</head>

<body>

    <!-- üîê Auth -->
    <script src="../../js/auth-check.js"></script>
    <script>
        requireAuth();
    </script>

    <button class="logout-btn" onclick="logout()">Sair</button>
    <br><br>

    <!-- Navega√ß√£o -->
    <button class="nav-btn" onclick="goTo('../dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="goTo('../eventos')">Eventos</button>
    <button class="nav-btn" onclick="goTo('../equipes')">Equipes</button>
    <button class="nav-btn" onclick="goTo('../cadastro')">Cadastro</button>
    <button class="nav-btn" onclick="goTo('../pessoas')">Pessoas</button>

    <!-- ================= EQUIPES DO EVENTO ================= -->
    <div class="card">
        <div class="bloco-header">
            <h2>‚ñ∂ Equipes do Evento</h2>
        </div>
        <button onclick="abrirModalVincularEquipe()"> Vincular Equipe ao Evento</button>

        <table>
            <thead>
                <tr>
                    <th>Nome da Equipe</th>
                    <th>Descri√ß√£o</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-equipes-evento"></tbody>
        </table>
    </div>

    <!-- ================= MODAL VINCULAR EQUIPE ================= -->
    <div id="modal-vincular-equipe" class="card-modal-overlay" style="display:none;">
        <div class="card-modal">
            <h3>Vincular Equipe ao Evento</h3>

            <label>Equipes</label>

            <label class="checkbox-item checkbox-select-all">
                <input type="checkbox" id="selectAllEquipes" />
                Selecionar todas as equipes
            </label>

            <div id="checkbox-equipes" class="checkbox-grid">
            </div>


            <br><br>
            <button onclick="salvarVinculoEquipe()">Salvar</button>
            <button onclick="fecharModalVincularEquipe()">Cancelar</button>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div class="modal-overlay" id="modalConfirm">
        <div class="modal">
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- ================= SCRIPTS ================= -->
    <script src="../../js/config.js"></script>
    <script src="../../js/loader.js"></script>

    <script type="module">
        const eventoId = localStorage.getItem("eventoId");

        import {
            listarEquipesDoEvento,
            desvincularEquipeDoEvento,
            vincularEquipeAoEvento
        } from "../../modules/equipes-evento.js";
        import { listarEquipes } from "../../modules/equipes.js";

        async function carregarEquipesDoEvento() {
            const vinculos = await listarEquipesDoEvento(eventoId);
            const tbody = document.getElementById("lista-equipes-evento");

            tbody.innerHTML = "";

            vinculos.forEach(v => {
                tbody.innerHTML += `
                    <tr>
                        <td>${v.equipe.nome}</td>
                        <td>${v.equipe.descricao ?? "-"}</td>
                        <td>
                        <button onclick="removerEquipe('${v.id}')">Remover</button>
                        </td>
                    </tr>
                    `;
            });
        }

        async function removerEquipe(vinculoId) {
            showConfirm("Tem certeza que deseja excluir este v√≠nculo?", () => {
                withLoader(async () => {
                    await desvincularEquipeDoEvento(vinculoId);
                    carregarEquipesDoEvento();
                });
            });
        }

        function abrirModalVincularEquipe() {
            document.getElementById("modal-vincular-equipe").style.display = "block";
            carregarSelectEquipes();
        }

        function fecharModalVincularEquipe() {
            document.getElementById("modal-vincular-equipe").style.display = "none";
        }

        async function carregarSelectEquipes() {
            const container = document.getElementById("checkbox-equipes");
            container.innerHTML = "";

            const checkboxSelectAll = document.getElementById("selectAllEquipes");
            checkboxSelectAll.checked = false;

            // todas as equipes
            const equipes = await listarEquipes();

            // equipes j√° vinculadas
            const vinculos = await listarEquipesDoEvento(eventoId);
            const equipesVinculadasIds = vinculos.map(v => v.equipe.id);

            equipes.forEach(eq => {
                const jaVinculada = equipesVinculadasIds.includes(eq.id);

                const label = document.createElement("label");
                label.style.display = "block";
                label.style.marginBottom = "6px";

                label.innerHTML = `
                <label class="checkbox-item ${jaVinculada ? 'checkbox-disabled' : ''}">
                    <input type="checkbox" value="${eq.id}" ${jaVinculada ? "checked disabled" : ""} />
                    ${eq.nome} ${jaVinculada ? "(j√° vinculada)" : ""}
                </label>`;

                container.appendChild(label);
            });

            // selecionar todos
            checkboxSelectAll.onchange = () => {
                const checkboxes = container.querySelectorAll(
                    'input[type="checkbox"]:not(:disabled)'
                );
                checkboxes.forEach(cb => cb.checked = checkboxSelectAll.checked);
            };
        }


        async function salvarVinculoEquipe() {
            const checkboxes = document.querySelectorAll(
                '#checkbox-equipes input[type="checkbox"]:checked:not(:disabled)'
            );

            await withLoader(async () => {
                for (const cb of checkboxes) {
                    await vincularEquipeAoEvento(eventoId, cb.value);
                }
            });

            fecharModalVincularEquipe();
            carregarEquipesDoEvento();
        }


        window.removerEquipe = removerEquipe;
        window.abrirModalVincularEquipe = abrirModalVincularEquipe;
        window.fecharModalVincularEquipe = fecharModalVincularEquipe;
        window.salvarVinculoEquipe = salvarVinculoEquipe;

        carregarEquipesDoEvento();
    </script>

</body>

</html>