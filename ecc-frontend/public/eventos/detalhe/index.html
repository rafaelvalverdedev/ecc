<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Evento • ECC</title>

    <link rel="stylesheet" href="../../css/estilos.css">
    <link rel="stylesheet" href="../../css/loader.css">
</head>

<body>

    <button onclick="voltar()"> ← Voltar</button>

    <h1 id="evento-nome">Carregando evento...</h1>

    <!-- Eventos -->
    <div class="card">
        <h2 class="toggle-title" data-id="eventos">
            ▶ Equipes do Evento
        </h2>
        <table class="grupo-eventos" style="display: none;">
            <thead>
                <tr>
                    <th>Nome da Equipe</th>
                    <th>Descrição da Equipe</th>
                </tr>
            </thead>
            <tbody id="equipes-evento-lista"></tbody>
        </table>
        <p id="equipes-vazio" style="display:none;">
            Nenhuma equipe vinculada a este evento.
        </p>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2> ▶ Pessoas do Evento</h2>
            <a href="./pessoas.html">Gerenciar pessoas</a>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Contato</th>
                    <th>Equipe</th>
                    <th>Papel</th>
                    <th>PGTO</th>
                </tr>
            </thead>
            <tbody id="pessoas-evento-lista"></tbody>
        </table>

        <p id="pessoas-vazio" style="display:none;">
            Nenhuma pessoa vinculada a este evento.
        </p>
    </div>

    <div class="card">
        <h2>Gestão do Evento</h2>

        <ul>
            <li><a href="./equipes.html">Equipes</a></li>
            <li><a href="./pessoas.html">Pessoas</a></li>
            <li><a href="./inscricoes.html">Inscrições</a></li>

            <li><a href="./vincularCasal.html">Vincular Casal ao Evento</a></li>
        </ul>
    </div>

    <script src="../../js/config.js"></script>
    <script src="../../js/loader.js"></script>

    <script>
        const token = localStorage.getItem("token");
        const eventoId = localStorage.getItem("eventoSelecionado");

        if (!token) {
            window.location.href = "../../auth/login.html";
        }

        if (!eventoId) {
            window.location.href = "../index.html";
        }

        function voltar() {
            window.location.href = "../../dashboard";
        }

        async function carregarEvento() {
            const res = await fetch(`${APP_CONFIG.API_BASE_URL}/eventos/${eventoId}`, {
                headers: { Authorization: "Bearer " + token }
            });

            const json = await res.json();
            document.getElementById("evento-nome").innerText = json.data.nome;
        }

        async function carregarEquipesEvento() {
            const res = await fetch(
                `${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`,
                { headers: { Authorization: "Bearer " + token } }
            );

            const json = await res.json();
            const lista = json.data || [];

            const tbody = document.getElementById("equipes-evento-lista");
            const vazio = document.getElementById("equipes-vazio");

            tbody.innerHTML = "";

            if (!lista.length) {
                vazio.style.display = "block";
                return;
            }

            vazio.style.display = "none";

            lista.forEach(item => {
                const eq = item.equipe;
                tbody.innerHTML += `
      <tr>
        <td>${eq.nome}</td>
        <td>${eq.descricao ?? "-"}</td>
      </tr>
    `;
            });
        }

        async function carregarPessoasEvento() {
            const tbodyEncontreiro = document.getElementById("pessoas-evento-lista");
            tbodyEncontreiro.innerHTML = "";

            try {
                // Carrega as equipes do evento
                const resEquipes = await fetch(`${APP_CONFIG.API_BASE_URL}/equipes-evento/evento/${eventoId}`, {
                    headers: { Authorization: "Bearer " + token }
                });
                const jsonEquipes = await resEquipes.json();
                const equipes = jsonEquipes.data || [];



                if (!equipes.length) {
                    document.getElementById("pessoas-vazio").style.display = "block";
                    return;
                }

                // Extrai os IDs das equipes vinculadas ao evento
                const idsEquipes = equipes.map(eq => eq.equipe.id);

                // Carrega as pessoas do evento
                const resPessoas = await fetch(`${APP_CONFIG.API_BASE_URL}/teamrole/evento/${eventoId}`, {
                    headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" }
                });

                const jsonPessoas = await resPessoas.json();
                const listaPessoas = (jsonPessoas.data || []).filter(tr => tr.pessoa?.role !== "admin");

                // Filtra as pessoas que estão nas equipes vinculadas ao evento
                const pessoasNoEvento = listaPessoas.filter(tr => {
                    return tr.equipe && idsEquipes.includes(tr.equipe.id);
                });

                if (!pessoasNoEvento.length) {
                    document.getElementById("pessoas-vazio").style.display = "block";
                    return;
                }

                // Exibe as pessoas no evento
                tbodyEncontreiro.innerHTML = "";
                pessoasNoEvento.forEach(tr => {
                    tbodyEncontreiro.innerHTML += `
                    <tr>
                        <td><a href="pessoas.html?id=${tr.cadastro?.id || "-"}"> ${tr.cadastro?.nome_completo_esposo || "-"} - <br> ${tr.cadastro?.nome_completo_esposa || "-"} </a></td>
                        <td>${tr.cadastro?.celular_esposo || "-"} - <br> ${tr.cadastro?.celular_esposa || "-"}</td>
                        <td>${tr.equipe?.nome || "-"}</td>
                        <td>
                            <span class="badge ${tr.is_leader ? "blue" : "red"}">
                                ${tr.is_leader ? "Coordenador" : "Encontreiro"}
                                </span>
                                </td>
                        <td>
                            <span class="badge ${tr.is_leader ? "blue" : "red"}">
                                ${tr.pagou ? "Sim" : "Não"}
                                </span>
                                </td>
                                </tr>
                                `;
                });

            } catch (err) {
                console.error("Erro ao carregar encontreiros inscritos:", err);
                document.getElementById("pessoas-vazio").textContent = "Erro ao carregar.";
            }
        }


        const ativarToggle = () => {
            document.querySelectorAll(".toggle-title").forEach(title => {
                title.addEventListener("click", () => {
                    const id = title.dataset.id;
                    const tabela = document.querySelector(`.grupo-${id}`);

                    if (!tabela) return;

                    const aberto = tabela.style.display !== "none";
                    tabela.style.display = aberto ? "none" : "table";

                    // Atualiza ícone
                    title.textContent = `${aberto ? "▶" : "▼"} ${title.textContent.replace(/[▶▼]\s*/, "")}`;
                });
            });
        };


        carregarPessoasEvento();
        carregarEquipesEvento();
        carregarEquipesEvento();
        ativarToggle();
        carregarEvento();
    </script>

</body>

</html>