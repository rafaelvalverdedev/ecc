<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes • ECC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="../css/estilos.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <link rel="stylesheet" href="../css/media-queries.css">
  <link rel="stylesheet" href="../css/formularios.css">
  <link rel="stylesheet" href="../css/loader.css">
</head>

<body>

  <!-- Navegação -->
  <div id="navbar"></div>

  <h1>Gerenciar Eventos</h1>

  <!-- ================= FORM EVENTO ================= -->
  <div class="card-modal-overlay" id="card" style="display:none;">
    <div class="card-modal">
      <h2 id="titulo-form">Novo Evento</h2>

      <form id="form-evento" onsubmit="salvarEvento(); return false;">
        <label>Nome</label>
        <input id="nome" required>

        <label>Local</label>
        <input id="local" required>

        <label>Data Início</label>
        <input type="date" id="start_date" required>

        <label>Data Fim</label>
        <input type="date" id="end_date" required>

        <label>Capacidade</label>
        <input type="number" id="capacity" required>

        <label>Valor Inscrições:</label>
        <input type="number" id="valor_encontreiro" min="0" required>

        <label>Valor Inscrições:</label>
        <input type="number" id="valor_encontrista" min="0" required>

        <br><br>
        <button type="submit">Salvar</button>
        <button type="button" onclick="limparFormulario()">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- ================= LISTAGEM ================= -->
  <div class="card">
    <h2>Eventos Cadastrados</h2>
    <button onclick="document.getElementById('card').style = 'display: block'">Cadastrar Novo Eventos</button>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Local</th>
          <th>Início</th>
          <th>Fim</th>
          <th>Capacidade</th>
          <th>Valor Encontreiro</th>
          <th>Valor Encontrista</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody id="lista-eventos"></tbody>
    </table>
  </div>

  <!-- MODAL DE CONFIRMAÇÃO -->
  <div class="modal-overlay" id="modalConfirm">
    <div class="modal">
      <p id="modalMessage"></p>
      <div class="modal-actions">
        <button onclick="closeModal()">Cancelar</button>
        <button onclick="confirmAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- ================= SCRIPTS ================= -->
  <script src="../js/config.js"></script>
  <script src="../js/loader.js"></script>
  <script src="../js/auth-check.js"></script>

  <script type="module">
    import {
      listarEventos,
      criarEvento,
      buscarEvento,
      atualizarEvento,
      excluirEvento
    } from "../modules/eventos.js";

    import { abrirEvento } from "../modules/dashboard.js";
    import { renderNavbar } from "../components/navbar.js";

    renderNavbar({ active: "eventos" });
    requireAuth();

    let eventoEditandoId = null;
    window.abrirEvento = abrirEvento;

    // =====================
    // LISTAR
    // =====================
    async function carregarEventos() {
      const eventos = await listarEventos();
      const tbody = document.getElementById("lista-eventos");
      tbody.innerHTML = "";

      eventos.forEach(ev => {
        tbody.innerHTML += `
          <tr>
            <td><a href="#" onclick="abrirEvento('${ev.id}')">${ev.nome}</a></td>
            <td>${ev.local}</td>
            <td>${formatarDataString(ev.start_date) ?? "-"}</td>
            <td>${formatarDataString(ev.end_date) ?? "-"}</td>
            <td>${ev.capacity ?? "-"}</td>
            <td>${formatarParaReal(ev.valor_encontreiro) ?? "-"}</td>
            <td>${formatarParaReal(ev.valor_encontrista) ?? "-"}</td>
            <td>
              <button onclick="editar('${ev.id}');"">Editar</button>
              <button onclick="deletar('${ev.id}');">Excluir</button>
            </td>
          </tr>
        `;
      });
    }

    // =====================
    // CREATE / UPDATE
    // =====================
    async function salvarEvento() {

      const data = {
        nome: document.getElementById("nome").value.trim(),
        local: document.getElementById("local").value.trim(),

        start_date: document.getElementById("start_date").value || null,
        end_date: document.getElementById("end_date").value || null,

        capacity: document.getElementById("capacity").value
          ? Number(document.getElementById("capacity").value)
          : null,

        // se existir no seu backend
        valor_encontreiro: document.getElementById("valor_encontreiro")?.value
          ? Number(document.getElementById("valor_encontreiro").value)
          : null,

        valor_encontrista: document.getElementById("valor_encontrista")?.value
          ? Number(document.getElementById("valor_encontrista").value)
          : null
      };

      await withLoader(async () => {
        if (eventoEditandoId) {
          await atualizarEvento(eventoEditandoId, data);
        } else {
          await criarEvento(data);
        }
      });

      limparFormulario();
      carregarEventos();
    }

    // =====================
    // EDITAR
    // =====================
    async function editar(id) {
      const ev = await buscarEvento(id);

      document.getElementById("card").style = "display: block";
      document.getElementById("titulo-form").innerText = "Editar Evento";
      document.getElementById("nome").value = ev.nome;
      document.getElementById("local").value = ev.local;
      document.getElementById("start_date").value = ev.start_date ?? "";
      document.getElementById("end_date").value = ev.end_date ?? "";
      document.getElementById("capacity").value = ev.capacity ?? "";
      document.getElementById("valor_encontreiro").value = ev.valor_encontreiro ?? "";
      document.getElementById("valor_encontrista").value = ev.valor_encontrista ?? "";

      eventoEditandoId = id;
    }

    // =====================
    // DELETE
    // =====================
    async function deletar(id) {
      showConfirm("Tem certeza que deseja excluir este equipe?", async () => {
        withLoader(async () => {
          await excluirEvento(id);
          carregarEventos();
        });
      });
    }

    function limparFormulario() {
      document.getElementById("form-evento").reset();
      document.getElementById("card").style = "display: none"
      document.getElementById("titulo-form").innerText = "Novo Evento";
      eventoEditandoId = null;
    }

    // =====================
    // INIT
    // =====================
    window.salvarEvento = salvarEvento;
    window.editar = editar;
    window.deletar = deletar;
    window.limparFormulario = limparFormulario;

    carregarEventos();
  </script>

</body>

</html>