<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Ficha de Inscri√ß√£o ‚Ä¢ ECC</title>
  <link rel="stylesheet" href="./css/estilos.css">
  <link rel="stylesheet" href="./css/loader.css">
</head>

<body>

  <h1>Cadastro Geral</h1>

  <div class="card">
    <form id="formInscricao">

      <br>
      <button type="button" onclick="preencherMock()">Preencher (DEV)</button>
      <br>

      <!-- ===================== ETAPA 1 - ESPOSO ====================== -->
      <div class="step active" id="step1">
        <h2>Dados do Esposo</h2>

        <label>Nome Completo</label>
        <input required id="nome_completo_esposo">

        <label>Data de Nascimento</label>
        <input type="date" required id="data_nascimento_esposo">

        <label>Profiss√£o</label>
        <input required id="profissao_esposo">

        <label>E-mail</label>
        <input required id="email_esposo">

        <label>Como deseja ser chamado</label>
        <input required id="como_chamar_esposo">

        <label>Igreja</label>
        <input required id="igreja_esposo">

        <label>Celular</label>
        <input type="tel" required id="celular_esposo">

        <label>Religi√£o</label>
        <select required id="religiao_esposo">
          <option value="" disabled selected>Selecione</option>
          <option value="catolico">Cat√≥lico</option>
          <option value="evangelico">Evang√©lico</option>
          <option value="espirita">Esp√≠rita</option>
          <option value="outro">Outro</option>
          <option value="nenhuma">Nenhuma</option>
        </select>

        <label>Escolaridade</label>
        <select required id="escolaridade_esposo">
          <option value="" disabled selected>Selecione</option>
          <option value="fundamental">Fundamental</option>
          <option value="medio">Ensino M√©dio</option>
          <option value="superior">Ensino Superior</option>
        </select>

        <button type="button" onclick="nextStep()">Pr√≥ximo</button>
      </div>

      <!-- ===================== ETAPA 2 - ESPOSA ====================== -->
      <div class="step" id="step2">
        <h2>Dados da Esposa</h2>

        <label>Nome Completo</label>
        <input required id="nome_completo_esposa">

        <label>Data de Nascimento</label>
        <input type="date" required id="data_nascimento_esposa">

        <label>Profiss√£o</label>
        <input required id="profissao_esposa">

        <label>E-mail</label>
        <input required id="email_esposa">

        <label>Como deseja ser chamada</label>
        <input required id="como_chamar_esposa">

        <label>Igreja</label>
        <input required id="igreja_esposa">

        <label>Celular</label>
        <input type="tel" required id="celular_esposa">

        <label>Religi√£o</label>
        <select required id="religiao_esposa">
          <option value="" disabled selected>Selecione</option>
          <option value="catolico">Cat√≥lico</option>
          <option value="evangelico">Evang√©lico</option>
          <option value="espirita">Esp√≠rita</option>
          <option value="outro">Outro</option>
          <option value="nenhuma">Nenhuma</option>
        </select>

        <label>Escolaridade</label>
        <select required id="escolaridade_esposa">
          <option value="" disabled selected>Selecione</option>
          <option value="fundamental">Fundamental</option>
          <option value="medio">Ensino M√©dio</option>
          <option value="superior">Ensino Superior</option>
        </select>

        <button type="button" onclick="prevStep()">Voltar</button>
        <button type="button" onclick="nextStep()">Pr√≥ximo</button>
      </div>

      <!-- ===================== ETAPA 3 - CASAL ====================== -->
      <div class="step" id="step3">
        <h2>Dados do Casal</h2>

        <label>Endere√ßo</label>
        <input required id="endereco">

        <label>Cidade</label>
        <input required id="cidade">

        <label>UF</label>
        <input required maxlength="2" id="uf">

        <label>Telefone</label>
        <input type="tel" required id="telefone_principal">

        <label>Possui filhos?</label>
        <select required id="possui_filhos" onchange="toggleFilhos()">
          <option value="" disabled selected>Selecione</option>
          <option value="false">N√£o</option>
          <option value="true">Sim</option>
        </select>

        <div id="dados_filhos" style="display:none">
          <label>Quantidade de filhos</label>
          <input type="number" min="1" id="quantidade_filhos">

          <label>Respons√°vel pelos filhos</label>
          <input id="nome_responsavel_filhos">

          <label>Telefone do respons√°vel</label>
          <input type="tel" id="telefone_responsavel">
        </div>

        <button type="button" onclick="prevStep()">Voltar</button>
        <button type="submit">Enviar</button>
      </div>

    </form>
  </div>

  <script src="./js/loader.js"></script>
  <script src="./js/config.js"></script>
  <script>
    // ======================================
    // üîê Autentica√ß√£o
    // ======================================
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));

    if (!token) { window.location.href = "./auth-login.html"; }

    // ======================================
    // üîì Logout
    // ======================================
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "./auth-login.html";
    }
    // --------- envio para o backend ----------
    const API_ENCONTRISTA_INSCR = `${APP_CONFIG.API_BASE_URL}/encontrista_inscricao`;
    let currentStep = 1;

    function showStep(n) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
    }

    function validarStep(stepId) {
      const step = document.getElementById(stepId);
      const fields = step.querySelectorAll('input, select');
      for (const f of fields) {
        if (!f.checkValidity()) {
          f.reportValidity();
          return false;
        }
      }
      return true;
    }

    function nextStep() {
      if (validarStep('step' + currentStep)) {
        currentStep++;
        showStep(currentStep);
      }
    }

    function prevStep() {
      currentStep--;
      showStep(currentStep);
    }

    function toggleFilhos() {
      const possui = document.getElementById('possui_filhos').value === 'true';
      const bloco = document.getElementById('dados_filhos');
      bloco.style.display = possui ? 'block' : 'none';
      bloco.querySelectorAll('input').forEach(i => i.required = possui);
    }

    function montarDTOInscricao() {
      return {
        esposo: {
          nomeCompleto: document.getElementById("nome_completo_esposo").value.trim(),
          dataNascimento: document.getElementById("data_nascimento_esposo").value,
          profissao: document.getElementById("profissao_esposo").value.trim(),
          celular: document.getElementById("celular_esposo").value.trim(),
          religiao: document.getElementById("religiao_esposo").value,
          escolaridade: document.getElementById("escolaridade_esposo").value
        },
        esposa: {
          nomeCompleto: document.getElementById("nome_completo_esposa").value.trim(),
          dataNascimento: document.getElementById("data_nascimento_esposa").value,
          profissao: document.getElementById("profissao_esposa").value.trim(),
          celular: document.getElementById("celular_esposa").value.trim(),
          religiao: document.getElementById("religiao_esposa").value,
          escolaridade: document.getElementById("escolaridade_esposa").value
        },
        casal: {
          endereco: document.getElementById("endereco").value.trim(),
          cidade: document.getElementById("cidade").value.trim(),
          uf: document.getElementById("uf").value.trim().toUpperCase(),
          telefone: document.getElementById("telefone_principal").value.trim(),
          possuiFilhos: document.getElementById("possui_filhos").value === "true"
        }
      };
    }

    document.getElementById('formInscricao').addEventListener('submit', function (e) {
      e.preventDefault();

      if (!validarStep('step3')) return;

      const dto = montarDTOInscricao();

      if (dto.casal.possuiFilhos) {
        dto.casal.quantidadeFilhos = parseInt(document.getElementById("quantidade_filhos").value, 10);
        dto.casal.nomeResponsavel = document.getElementById("nome_responsavel_filhos").value.trim();
        dto.casal.telefoneResponsavel = document.getElementById("telefone_responsavel").value.trim();

        if (!dto.casal.quantidadeFilhos || !dto.casal.nomeResponsavel || !dto.casal.telefoneResponsavel) {
          alert("Preencha corretamente os dados dos filhos");
          return;
        }
      }

      enviarInscricao(dto);
    });

    async function enviarInscricao(dto) {
      // const res = await fetch("/api/inscricoes", {
      //   method: "POST",
      //   headers: { "Content-Type": "application/json" },
      //   body: JSON.stringify(dto)
      // });

      // if (!res.ok) {

      //   console.log(dto);
      //   alert("Erro ao salvar inscri√ß√£o");
      //   return;
      // }

      // alert("Inscri√ß√£o enviada com sucesso!");


      const res = await fetch(API_ENCONTRISTA_INSCR, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify(dto)
      });

      if (!res.ok) {
        const erro = await res.json().catch(() => ({}));
        alert(erro.error || "Erro ao salvar inscri√ß√£o");
        return;
      }

      alert("Inscri√ß√£o enviada com sucesso!");
      document.getElementById("formInscricao").reset();
      currentStep = 1;
      showStep(currentStep);

    }


    function preencherMock() {
      // Esposo
      document.getElementById("nome_completo_esposo").value = "Jo√£o da Silva";
      document.getElementById("data_nascimento_esposo").value = "1985-05-10";
      document.getElementById("profissao_esposo").value = "Engenheiro";
      document.getElementById("email_esposo").value = "joao@silva.com";
      document.getElementById("como_chamar_esposo").value = "Jo√£o";
      document.getElementById("igreja_esposo").value = "Par√≥quia Central";
      document.getElementById("celular_esposo").value = "11999999999";
      document.getElementById("religiao_esposo").value = "catolico";
      document.getElementById("escolaridade_esposo").value = "superior";

      // Esposa
      document.getElementById("nome_completo_esposa").value = "Maria da Silva";
      document.getElementById("data_nascimento_esposa").value = "1987-08-15";
      document.getElementById("profissao_esposa").value = "Professora";
      document.getElementById("email_esposa").value = "maria@silva.com";
      document.getElementById("como_chamar_esposa").value = "Maria";
      document.getElementById("igreja_esposa").value = "Par√≥quia Central";
      document.getElementById("celular_esposa").value = "11988888888";
      document.getElementById("religiao_esposa").value = "catolico";
      document.getElementById("escolaridade_esposa").value = "superior";

      // Casal
      document.getElementById("endereco").value = "Rua Teste, 123";
      document.getElementById("cidade").value = "S√£o Paulo";
      document.getElementById("uf").value = "SP";
      document.getElementById("telefone_principal").value = "1133334444";
      document.getElementById("possui_filhos").value = "false";

      alert("Formul√°rio preenchido automaticamente (DEV)");
    }

  </script>
</body>

</html>