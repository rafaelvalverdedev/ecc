<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes â€¢ ECC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="../css/estilos.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <link rel="stylesheet" href="../css/media-queries.css">
  <link rel="stylesheet" href="../css/formularios.css">
  <link rel="stylesheet" href="../css/loader.css">
</head>

<body>

  <!-- NavegaÃ§Ã£o -->
  <div id="navbar"></div>

  <h1 style="margin-left: 10px;">Gerenciar Equipes</h1>

  <button id="nav-btn" onclick="mostrarCardEquipe()" style="margin-left: 10px;">Cadastrar Equipes</button>
  <button onclick="mostrarCardVinculo();"> Vincular Equipe a Evento </button>

  <!-- FORM EDITAR / CRIAR EQUIPE -->
  <div class="card-modal-overlay" id="card" style="display:none;">
    <div class="card-modal">
      <h2>Criar / Editar Equipe</h2>
      <form id="form-equipe" onsubmit="withLoader(() => salvarEquipe(event))">
        <input type="hidden" id="equipe_id">

        <label>Nome:</label>
        <input id="nome" required>

        <label>DescriÃ§Ã£o:</label>
        <input id="descricao" required>
        <div class="form-button">
          <button type="button" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
          <button type="submit" id="btnSalvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FORM DE VÃNCULO -->
  <div class="card-modal-overlay" id="card-edit" style="display:none;">
    <div class="card-modal">

      <h2>Criar/Atualizar VÃ­nculos</h2>

      <form id="form-vinculo" onsubmit="withLoader(() => salvarVinculos(event))">
        <label>Evento:</label>
        <select id="evento_id" onchange="renderizarCheckboxes()"></select>

        <!-- SELECIONAR TODOS -->
        <div>
          <label>Equipes:</label>
          <label class="checkbox-item checkbox-select-all">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
            <span>Selecionar todos</span>
          </label>
          <div id="checkboxContainer" class="checkbox-grid"></div>
        </div>
        <div class="form-button">
          <button type="button" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
          <button type="submit" id="btnSalvar">Salvar VÃ­nculos</button>
        </div>
      </form>
    </div>
  </div>

  <!-- LISTA DE VÃNCULOS -->
  <div class="card">
    <h2>VÃ­nculos cadastrados</h2>
    <table>
      <tbody id="lista-vinculos"></tbody>
    </table>
  </div>

  <!-- EQUIPES CADASTRADAS -->
  <div class="card">
    <h2>Equipes cadastradas</h2>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>DescriÃ§Ã£o</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="lista-equipes"></tbody>
    </table>
  </div>

  <!-- MODAL DE CONFIRMAÃ‡ÃƒO -->
  <div class="modal-overlay" id="modalConfirm">
    <div class="modal">
      <p id="modalMessage"></p>
      <div class="modal-actions">
        <button onclick="closeModal()">Cancelar</button>
        <button onclick="confirmAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- ================= SCRIPTS ================= -->
  <script src="../js/config.js"></script>
  <script src="../js/loader.js"></script>
  <script src="../js/auth-check.js"></script>

  <script type="module">
    requireRole(["admin", "coordenador"]); // Apenas administradores podem acessar

    import { renderNavbar } from "../components/navbar.js";
    renderNavbar({ active: "equipes" });

  </script>

  <script>
    const token = localStorage.getItem("token");
    const API_URL = `${APP_CONFIG.API_BASE_URL}/equipes`;

    // ============================
    // ðŸ“Œ LISTAR EQUIPES
    // ============================
    async function listarEquipes() {
      try {
        const res = await fetch(API_URL, { headers: { Authorization: "Bearer " + token } });

        const resultado = await res.json();
        const equipes = resultado.data;

        const tbody = document.getElementById("lista-equipes");
        tbody.innerHTML = "";

        equipes.forEach(eq => {
          tbody.innerHTML += `
            <tr>
              <td>${eq.nome}</td>
              <td>${eq.descricao ?? "-"}</td>
              <td>
                <button onclick="carregarEquipe('${eq.id}')">Editar</button>
                <button onclick="withLoader(() => excluirEquipe('${eq.id}'))">Excluir</button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error("Erro ao listar equipes:", error);
      }
    }

    // ============================
    // SALVAR (CRIAR OU EDITAR)
    // ============================
    async function salvarEquipe(event) {
      event.preventDefault();

      const id = document.getElementById("equipe_id").value;
      const payload = {
        nome: document.getElementById("nome").value,
        descricao: document.getElementById("descricao").value
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `${API_URL}/${id}` : API_URL;

      try {
        const res = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          showToast("Erro ao salvar equipe");
          return;
        }

        showToast("Equipe salva!");
        cancelarEdicao();
        listarEquipes();
      } catch (error) {
        console.error("Erro ao salvar equipe:", error);
      }
    }

    // ============================
    // EDITAR
    // ============================
    async function editarEquipe(id) {
      const res = await fetch(`${API_URL}/${id}`, {
        headers: { Authorization: "Bearer " + token }
      });

      const eq_res = await res.json();
      const eq = eq_res.data;

      document.getElementById("equipe_id").value = eq.id;
      document.getElementById("nome").value = eq.nome;
      document.getElementById("descricao").value = eq.descricao;

      document.getElementById("btn-cancelar").style.display = "inline-block";
    }

    // ======================================
    // CARREGAR EQUIPE PARA EDIÃ‡ÃƒO
    // ======================================
    async function carregarEquipe(id) {
      try {
        const response = await fetch(`${API_URL}/${id}`, {
          headers: { Authorization: "Bearer " + token }
        });
        const equipes = await response.json();
        const ev = equipes.data;

        document.getElementById("equipe_id").value = ev.id;
        document.getElementById("nome").value = ev.nome;
        document.getElementById("descricao").value = ev.descricao || "";

        document.getElementById("card").style.display = "block";
        document.getElementById("btn-cancelar").style.display = "inline-block";
        document.getElementById("nav-btn").style.display = "none";

      } catch (error) {
        console.error("Erro ao carregar equipe:", error);
      }
    }

    // ============================
    // CANCELAR EDIÃ‡ÃƒO
    // ============================
    function cancelarEdicao() {
      document.getElementById("form-equipe").reset();
      document.getElementById("form-vinculo").reset();

      document.getElementById("card-edit").style.display = "none";
      document.getElementById("card").style.display = "none";

    }

    // ============================
    // EXCLUIR EQUIPE
    // ============================
    async function excluirEquipe(id) {
      showConfirm("Tem certeza que deseja excluir este equipe?", async () => {
        withLoader(async () => {
          try {
            const response = await fetch(`${API_URL}/${id}`, {
              method: "DELETE",
              headers: { Authorization: "Bearer " + token }
            });

            if (!response.ok) {
              showToast("Erro ao excluir equipe");
              return;
            }

            showToast("Equipe excluÃ­da!");
            await carregarListas();
            await listarEquipes();
          } catch (error) {
            console.error("Erro ao excluir equipe:", error);
            showToast("Erro ao excluir equipe");
          }
        });
      });
    }

    // ============================
    // LISTAR VÃNCULOS NA TABELA
    // ============================
    function listarVinculos() {
      const tbody = document.getElementById("lista-vinculos");
      tbody.innerHTML = "";

      const grupos = {};

      vinculos.forEach(v => {
        const eventoNome = v.evento?.nome || "(Sem nome)";
        if (!grupos[eventoNome]) grupos[eventoNome] = [];
        grupos[eventoNome].push(v);
      });

      Object.keys(grupos).forEach(eventoNome => {
        const lista = grupos[eventoNome];
        const id = eventoNome.replace(/\s+/g, "_");

        // HEADER (toggle principal)
        tbody.innerHTML += `
              <tr>
                <td class="toggle-title" data-id="${id}" style="background-color: #f9f9f9;">
                  <span>
                    â–¶ ${eventoNome} â€” ${lista.length} equipe(s)
                  </span>
                </td>
              </tr>
            `;

        // CONTAINER ÃšNICO DOS SUBITENS (OBRIGATÃ“RIO)
        tbody.innerHTML += `
              <tr>
                <td style="padding: 0;">
                  <table class="grupo-${id}" style="display: none;">
                      ${lista.map(v => `
                        <tr>
                          <td>
                            ${v.equipe?.nome ?? "-"}
                          </td>
                          <td>
                            <button  onclick="excluirVinculo('${v.id}')">Excluir</button>
                          </td>
                        </tr>
                      `).join("")}
                  </table>
                </td>
              </tr>
            `;
      });

      ativarToggle();
    }

    // ============================
    // SALVAR VÃNCULOS
    // ============================
    async function salvarVinculos(event) {
      event.preventDefault();

      const eventoId = document.getElementById("evento_id").value;

      const selecionadas = Array.from(
        document.querySelectorAll(
          "#checkboxContainer input:checked:not(:disabled)"
        )
      ).map(cb => cb.value);

      const vinculadasAntes = vinculos
        .filter(v => v.evento_id === eventoId)
        .map(v => v.equipe_id);

      const paraCriar = selecionadas.filter(id => !vinculadasAntes.includes(id));
      const paraExcluir = vinculadasAntes.filter(id => !selecionadas.includes(id));

      // Criar vÃ­nculos
      for (const equipeId of paraCriar) {
        const res = await fetch(API_VINCULOS, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            evento_id: eventoId,
            equipe_id: equipeId
          })
        });

        if (!res.ok) {
          throw new Error("Erro ao criar vÃ­nculo");
        }
      }

      // Excluir vÃ­nculos
      for (const equipeId of paraExcluir) {
        const vinculo = vinculos.find(
          v => v.evento_id === eventoId && v.equipe_id === equipeId
        );

        if (vinculo) {
          const res = await fetch(`${API_VINCULOS}/${vinculo.id}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token }
          });

          if (!res.ok) {
            throw new Error("Erro ao excluir vÃ­nculo");
          }
        }
      }

      await carregarListas();
      showToast("VÃ­nculos atualizados com sucesso!");
      cancelarEdicao();
    }

    // ============================
    // EXCLUIR VÃNCULO
    // ============================
    function excluirVinculo(id) {
      showConfirm("Tem certeza que deseja excluir este vÃ­nculo?", () => {
        withLoader(async () => {
          try {
            const res = await fetch(`${API_VINCULOS}/${id}`, {
              method: "DELETE",
              headers: { Authorization: "Bearer " + token },
            });

            if (!res.ok) {
              showToast("Erro ao excluir vÃ­nculo.");
              return;
            }

            await carregarListas();
            await listarEquipes();
            showToast("VÃ­nculo excluÃ­do com sucesso!");

          } catch (err) {
            console.error(err);
            showToast("Erro ao excluir vÃ­nculo.");
          }
        });
      });
    }


    // FunÃ§Ã£o para exibir o card de criaÃ§Ã£o/ediÃ§Ã£o
    function mostrarCardEquipe() {
      document.getElementById("card").style.display = "block";
      document.getElementById("card-edit").style.display = "none";
      document.getElementById("btn-cancelar").style.display = "block";
    }

    // FunÃ§Ã£o para exibir o card de criaÃ§Ã£o/ediÃ§Ã£o
    function mostrarCardVinculo() {
      document.getElementById("card").style.display = "none";
      document.getElementById("card-edit").style.display = "block";
      document.getElementById("btn-cancelar").style.display = "block";
      carregarListas();
    }

    // ============================
    // CARREGAR EVENTOS / EQUIPES / VÃNCULOS
    // ============================

    const API_EVENTOS = `${APP_CONFIG.API_BASE_URL}/eventos`;
    const API_EQUIPES = `${APP_CONFIG.API_BASE_URL}/equipes`;
    const API_VINCULOS = `${APP_CONFIG.API_BASE_URL}/equipes-evento`;

    let eventos = [];
    let equipes = [];
    let vinculos = [];

    async function carregarListas() {
      try {
        const eventosRes = await fetch(API_EVENTOS, { headers: { Authorization: "Bearer " + token } });
        const eventosJson = await eventosRes.json();
        eventos = eventosJson.data?.data || eventosJson.data || [];

        const equipesRes = await fetch(API_EQUIPES, { headers: { Authorization: "Bearer " + token } });
        const equipesJson = await equipesRes.json();
        equipes = equipesJson.data?.data || equipesJson.data || [];

        const vinculosRes = await fetch(API_VINCULOS, { headers: { Authorization: "Bearer " + token } });
        const vinculosJson = await vinculosRes.json();
        vinculos = vinculosJson.data?.data || vinculosJson.data || [];

        preencherEventos();
        renderizarCheckboxes();
        listarVinculos();

      } catch (err) {
        console.error("Erro ao carregar listas:", err);
        showToast("Erro ao carregar dados.");
      }
    }

    // SELECT DE EVENTOS
    function preencherEventos() {
      const select = document.getElementById("evento_id");
      if (!select) return;

      select.innerHTML = "";

      eventos.forEach(ev => {
        select.innerHTML += `<option value="${ev.id}">${ev.nome}</option>`;
      });
    }

    // RENDERIZAR CHECKBOXES + SINCRONIZAR
    function renderizarCheckboxes() {
      const eventoId = document.getElementById("evento_id").value;
      const container = document.getElementById("checkboxContainer");
      const selectAll = document.getElementById("selectAll");

      container.innerHTML = "";
      selectAll.checked = false;

      if (!eventoId) return;

      const vinculadas = vinculos
        .filter(v => v.evento?.id === eventoId)
        .map(v => v.equipe?.id);

      equipes.forEach(eq => {
        const jaVinculada = vinculadas.includes(eq.id);

        container.innerHTML += `
      <label class="checkbox-item ${jaVinculada ? 'checkbox-disabled' : ''}">
        <input
          type="checkbox"
          value="${eq.id}"
          ${jaVinculada ? 'checked disabled' : ''}
          onchange="syncSelectAll()"
        >
        <span>${eq.nome}</span>
      </label>
    `;
      });

      syncSelectAll();
    }

    // ðŸ”µ SELECIONAR TODOS
    function toggleSelectAll(master) {
      const checkboxes = document.querySelectorAll(
        '#checkboxContainer input[type="checkbox"]:not(:disabled)'
      );

      checkboxes.forEach(cb => cb.checked = master.checked);
    }

    // ðŸ”µ Sincronizar estado do selectAll
    function syncSelectAll() {
      const checkboxes = document.querySelectorAll(
        '#checkboxContainer input[type="checkbox"]:not(:disabled)'
      );

      if (checkboxes.length === 0) {
        document.getElementById("selectAll").checked = false;
        return;
      }

      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      document.getElementById("selectAll").checked = allChecked;
    }

    // â–¶ INICIAR
    withLoader(async () => {
      await listarEquipes();
      await carregarListas();
    });
  </script>

</body>

</html>