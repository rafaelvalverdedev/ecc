<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes ‚Ä¢ ECC</title>
  <link rel="stylesheet" href="../css/estilos.css">
  <link rel="stylesheet" href="../css/loader.css">
</head>

<body>

  <button class="logout-btn" onclick="logout()">Sair</button>
  <br><br>

  <!-- Navega√ß√£o -->
  <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
  <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
  <button class="nav-btn" onclick="goTo('cadastro')">Cadastro</button>
  <button class="nav-btn" onclick="goTo('encontreiro')">Encontreiro</button>
  <!-- <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
  <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>
  <button class="nav-btn" onclick="goTo('inscricoes')">Inscri√ß√µes</button> -->

  <h1>Gerenciar Equipes</h1> <span><a href="../dashboard"> ‚Üê Voltar</a></span>
  <br>
  <button class="nav-btn" id="nav-btn" onclick="mostrarCardEquipe()">Cadastrar Equipes</button>
  <button class="nav-btn" onclick="mostrarCardVinculo();"> Vincular Equipe a Evento </button>

  <div class="card" id="card" style="display:none;">
    <!-- FORM EDITAR / CRIAR EQUIPE -->
    <h2>Criar / Editar Equipe</h2>
    <form id="form-equipe" onsubmit="salvarEquipe(event)">
      <input type="hidden" id="equipe_id">

      <label>Nome:</label>
      <input id="nome" required>

      <label>Descri√ß√£o:</label>
      <input id="descricao" required>

      <button type="button" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
      <button type="submit" id="btnSalvar">Salvar</button>
    </form>
  </div>


  <!-- FORM DE V√çNCULO -->
  <div class="card-edit" id="card" style="display:none;">
    <h2>Criar/Atualizar V√≠nculos</h2>

    <form id="form-vinculo" onsubmit="withLoader(() => salvarVinculos(event))">
      <label>Evento:</label>
      <select id="evento_id" onchange="renderizarCheckboxes()"></select>

      <!-- SELECIONAR TODOS -->
      <div>
        <label>Equipes:</label>
        <label class="checkbox-item checkbox-select-all">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
          <span>Selecionar todos</span>
        </label>
        <div id="checkboxContainer" class="checkbox-grid"></div>
      </div>

      <button type="button" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
      <button type="submit" id="btnSalvar">Salvar V√≠nculos</button>
    </form>
  </div>


  <!-- LISTA DE V√çNCULOS -->
  <div class="card">
    <h2>V√≠nculos cadastrados</h2>
    <table>
      <tbody id="lista-vinculos"></tbody>
    </table>
  </div>

  <!-- EQUIPES CADASTRADAS -->
  <div class="card">
    <h2>Equipes cadastradas</h2>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Descri√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="lista-equipes"></tbody>
    </table>
  </div>

  <!-- MODAL DE CONFIRMA√á√ÉO -->
  <div class="modal-overlay" id="modalConfirm">
    <div class="modal">
      <p id="modalMessage"></p>
      <div class="modal-actions">
        <button onclick="closeModal()">Cancelar</button>
        <button onclick="confirmAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script src="../js/loader.js"></script>
  <script src="../js/config.js"></script>
  <script>
    // ============================
    // üîê Autentica√ß√£o
    // ============================
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));

    if (!token) { window.location.href = "./auth-login.html"; }

    // ============================
    // üîì Logout
    // ============================
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "./auth-login.html";
    }

    const API_URL = `${APP_CONFIG.API_BASE_URL}/equipes`;

    // ============================
    // üìå LISTAR EQUIPES
    // ============================
    async function listarEquipes() {
      try {
        const res = await fetch(API_URL, { headers: { Authorization: "Bearer " + token } });

        const resultado = await res.json();
        const equipes = resultado.data;

        const tbody = document.getElementById("lista-equipes");
        tbody.innerHTML = "";

        equipes.forEach(eq => {
          tbody.innerHTML += `
        <tr>
          <td>${eq.nome}</td>
          <td>${eq.descricao ?? "-"}</td>
          <td>
            <button onclick="carregarEquipe('${eq.id}')">Editar</button>
            <button onclick="excluirEquipe('${eq.id}')">Excluir</button>
          </td>
        </tr>
      `;
        });
      } catch (error) {
        console.error("Erro ao listar equipes:", error);
      }
    }

    // ============================
    // üìå SALVAR (CRIAR OU EDITAR)
    // ============================
    async function salvarEquipe(event) {
      event.preventDefault();

      const id = document.getElementById("equipe_id").value;
      const payload = {
        nome: document.getElementById("nome").value,
        descricao: document.getElementById("descricao").value
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `${API_URL}/${id}` : API_URL;

      try {
        const res = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          showToast("Erro ao salvar equipe");
          return;
        }

        showToast("Equipe salva!");
        cancelarEdicao();
        listarEquipes();
      } catch (error) {
        console.error("Erro ao salvar equipe:", error);
      }
    }

    // ============================
    // üìå EDITAR
    // ============================
    async function editarEquipe(id) {
      const res = await fetch(`${API_URL}/${id}`, {
        headers: { Authorization: "Bearer " + token }
      });

      const eq_res = await res.json();
      const eq = eq_res.data;

      document.getElementById("equipe_id").value = eq.id;
      document.getElementById("nome").value = eq.nome;
      document.getElementById("descricao").value = eq.descricao;

      document.getElementById("btn-cancelar").style.display = "inline-block";
    }

    // ======================================
    // üìå CARREGAR EQUIPE PARA EDI√á√ÉO
    // ======================================
    async function carregarEquipe(id) {
      try {
        const response = await fetch(`${API_URL}/${id}`, {
          headers: { Authorization: "Bearer " + token }
        });
        const equipes = await response.json();
        const ev = equipes.data;

        document.getElementById("equipe_id").value = ev.id;
        document.getElementById("nome").value = ev.nome;
        document.getElementById("descricao").value = ev.descricao || "";

        document.getElementById("card").style.display = "block";
        document.getElementById("btn-cancelar").style.display = "inline-block";
        document.getElementById("nav-btn").style.display = "none";

      } catch (error) {
        console.error("Erro ao carregar equipe:", error);
      }
    }

    // ============================
    // üìå CANCELAR EDI√á√ÉO
    // ============================
    function cancelarEdicao() {
      document.getElementById("equipe_id").value = "";
      document.getElementById("form-equipe").reset();
      document.getElementById("btn-cancelar").style.display = "none";
      const cardEquipes = document.getElementById("card");
      cardEquipes.style.display = "none";

      // Exibe novamente o bot√£o de cadastrar equipe
      const btnCadastrar = document.querySelector("button[onclick='mostrarCardEquipe()']");
      btnCadastrar.style.display = "inline-block";  // Exibe o bot√£o "Cadastrar equipe" novamente
      document.getElementById("form-equipe").reset();  // Reseta o formul√°rio
      document.getElementById("btn-cancelar").style.display = "none";  // Oculta o bot√£o "Cancelar"
    }

    // Fun√ß√£o para exibir o card de cria√ß√£o/edi√ß√£o
    function mostrarCardEquipe() {
      document.getElementById("card").style.display = "block";  // Torna o card vis√≠vel
      document.getElementById("card-edit").style.display = "none";  // Torna o card vis√≠vel

      // Oculta o bot√£o de cadastrar
      const btnCadastrar = document.querySelector("button[onclick='mostrarCardEquipe()']");
      document.getElementById("btn-cancelar").style.display = "block";  // Oculta o bot√£o "Cancelar"
    }

    // Fun√ß√£o para exibir o card de cria√ß√£o/edi√ß√£o
    function mostrarCardVinculo() {
      document.getElementById("card").style.display = "none";  // Torna o card vis√≠vel
      document.getElementById("card-edit").style.display = "block";  // Torna o card vis√≠vel
      // Oculta o bot√£o de cadastrar
      const btnCadastrar = document.querySelector("button[onclick='mostrarCardVinculo()']");
      document.getElementById("btn-cancelar").style.display = "block";  // Oculta o bot√£o "Cancelar"
    }

    // ============================
    // üìå EXCLUIR EQUIPE
    // ============================
    async function excluirEquipe(id) {
      showConfirm("Tem certeza que deseja excluir este equipe?", async () => {
        try {
          const response = await fetch(`${API_URL}/${id}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token }
          });

          if (!response.ok) {
            showToast("Erro ao excluir equipe");
            return;
          }

          showToast("Equipe exclu√≠da!");
          listarEquipes();
        } catch (error) {
          console.error("Erro ao excluir equipe:", error);
          showToast("Erro ao excluir equipe");
        }
      });
    }



    // ============================
    // üîµ CARREGAR EVENTOS / EQUIPES / V√çNCULOS
    // ============================

    const API_EVENTOS = `${APP_CONFIG.API_BASE_URL}/eventos`;
    const API_EQUIPES = `${APP_CONFIG.API_BASE_URL}/equipes`;
    const API_VINCULOS = `${APP_CONFIG.API_BASE_URL}/equipes-evento`;

    let eventos = [];
    let equipes = [];
    let vinculos = [];

    async function carregarListas() {
      try {
        const eventosRes = await fetch(API_EVENTOS, { headers: { Authorization: "Bearer " + token } });
        const eventosJson = await eventosRes.json();
        eventos = eventosJson.data?.data || eventosJson.data || [];

        const equipesRes = await fetch(API_EQUIPES, { headers: { Authorization: "Bearer " + token } });
        const equipesJson = await equipesRes.json();
        equipes = equipesJson.data?.data || equipesJson.data || [];

        const vinculosRes = await fetch(API_VINCULOS, { headers: { Authorization: "Bearer " + token } });
        const vinculosJson = await vinculosRes.json();
        vinculos = vinculosJson.data?.data || vinculosJson.data || [];

        listarVinculos();

      } catch (err) {
        console.error("Erro ao carregar listas:", err);
        showToast("Erro ao carregar dados.");
      }
    }




    // ============================
    // üîµ LISTAR V√çNCULOS NA TABELA
    // ============================
    function listarVinculos() {
      const tbody = document.getElementById("lista-vinculos");
      tbody.innerHTML = "";

      const grupos = {};

      vinculos.forEach(v => {
        const eventoNome = v.evento?.nome || "(Sem nome)";
        if (!grupos[eventoNome]) grupos[eventoNome] = [];
        grupos[eventoNome].push(v);
      });

      Object.keys(grupos).forEach(eventoNome => {
        const lista = grupos[eventoNome];
        const id = eventoNome.replace(/\s+/g, "_");

        // HEADER (toggle principal)
        tbody.innerHTML += `
          <tr>
            <td>
              <span class="toggle-title" data-id="${id}">
                ‚ñ∂ ${eventoNome} ‚Äî ${lista.length} equipe(s)
              </span>
            </td>
          </tr>
        `;

        // CONTAINER √öNICO DOS SUBITENS (OBRIGAT√ìRIO)
        tbody.innerHTML += `
          <tr class="grupo-${id}" style="display: none;">
            <td>
              <table>
                  ${lista.map(v => `
                    <tr>
                      <td>
                        ${v.equipe?.nome ?? "-"}
                      </td>
                      <td>
                        <button  onclick="excluirVinculo('${v.id}')">Excluir</button>
                      </td>
                    </tr>
                  `).join("")}
              </table>
            </td>
          </tr>
        `;
      });

      ativarToggle();
    }
    // ‚ñ∂ INICIAR
    withLoader(() => listarEquipes(), listarVinculos(), carregarListas(), ativarToggle());
  </script>

</body>

</html>