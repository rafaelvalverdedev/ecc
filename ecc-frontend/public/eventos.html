<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes ‚Ä¢ ECC</title>
  <link rel="stylesheet" href="./css/estilos.css">
  <link rel="stylesheet" href="./css/loader.css">
</head>

<body>

  <button class="logout-btn" onclick="logout()">Sair</button>
  <br><br>

  <!-- Navega√ß√£o -->
  <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
  <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
  <button class="nav-btn" onclick="goTo('equipes_evento')">Evento x Equipe</button>
  <button class="nav-btn" onclick="goTo('encontreiro')">Encontreiro</button>
  <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
  <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>
  <button class="nav-btn" onclick="goTo('inscricoes')">Inscri√ß√µes</button>

  <h1>Gerenciar Eventos</h1>
  <button class="nav-btn" onclick="mostrarCardEvento()">Cadastrar Evento</button>

  <div class="card" id="card" style="display:none;">
    <h2>Criar / Editar Evento</h2>

    <form id="form-evento" onsubmit="salvarEvento(event)">
      <input type="hidden" id="evento_id">

      <label>Nome:</label>
      <input id="nome" required>

      <label>Descri√ß√£o:</label>
      <input id="descricao" required>

      <label>Local:</label>
      <input id="local" required>

      <label>Data In√≠cio:</label>
      <input type="date" id="start_date" required>

      <label>Data Fim:</label>
      <input type="date" id="end_date" required>

      <label>Qtd Inscri√ß√µes:</label>
      <input type="number" id="capacity" min="0" required>

      <label>Valor Inscri√ß√µes:</label>
      <input type="number" id="valor_encontreiro" min="0" required>

      <label>Valor Inscri√ß√µes:</label>
      <input type="number" id="valor_encontrista" min="0" required>

      <button id="btn-criar" type="submit">Salvar</button>
      <button id="btn-cancelar" type="button" onclick="cancelarEdicao()">
        Cancelar
      </button>
    </form>
  </div>


  <div class="card">
    <h2>Lista de Eventos</h2>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Local</th>
          <th>In√≠cio</th>
          <th>Fim</th>
          <th>Capacidade</th>
          <th>ValorInscri√ß√£o Encontreiro</th>
          <th>Valor Inscri√ß√£o Encontrista</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="lista-eventos"></tbody>
    </table>
  </div>

  <script src="./js/loader.js"></script>
  <script src="./js/config.js"></script>
  <script>
    // ======================================
    // üîê Autentica√ß√£o
    // ======================================
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "./auth-login.html";
    }

    // ======================================
    // üîì Logout
    // ======================================
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "./auth-login.html";
    }

    // ======================================
    // üîÑ Navega√ß√£o
    // ======================================
    function goTo(page) {
      window.location.href = `./${page}.html`;
    }

    const API_URL = `${APP_CONFIG.API_BASE_URL}/eventos`;

    // ======================================
    // üìå LISTAR EVENTOS
    // ======================================
    async function listarEventos() {
      try {
        const res = await fetch(API_URL, { headers: { Authorization: "Bearer " + token } });

        const resultado = await res.json();
        const eventos = resultado.data;

        const tbody = document.getElementById("lista-eventos");
        tbody.innerHTML = "";

        eventos.forEach(ev => {
          tbody.innerHTML += `
          <tr>
            <td>${ev.nome}</td>
            <td>${ev.local}</td>
            <td>${ev.start_date ?? "-"}</td>
            <td>${ev.end_date ?? "-"}</td>
            <td>${ev.capacity ?? "-"}</td>
            <td>R$ ${ev.valor_encontreiro ?? "-"},00</td>
            <td>R$ ${ev.valor_encontrista ?? "-"},00</td>            
            <td>
              <button onclick="carregarEvento('${ev.id}')">Editar</button>
              <button onclick="deletarEvento('${ev.id}')">Excluir</button>
            </td>
          </tr>
        `;
        });
      } catch (error) {
        console.error("Erro ao listar eventos:", error);
      }
    }

    // ======================================
    // üìå CRIAR / ATUALIZAR EVENTO
    // ======================================
    async function salvarEvento(event) {
      event.preventDefault();

      const id = document.getElementById("evento_id").value;

      const data = {
        nome: document.getElementById("nome").value,
        descricao: document.getElementById("descricao").value,
        local: document.getElementById("local").value,
        start_date: document.getElementById("start_date").value,
        end_date: document.getElementById("end_date").value || null,
        capacity: document.getElementById("capacity").value
          ? Number(document.getElementById("capacity").value)
          : null,
        valor_encontreiro: parseInt(document.getElementById("valor_encontreiro").value),
        valor_encontrista: parseInt(document.getElementById("valor_encontrista").value),
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `${API_URL}/${id}` : API_URL;

      try {
        const response = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          let msg = "Erro ao salvar evento";
          try {
            const err = await response.json();
            if (err.error) msg = err.error;
          } catch (_) { }
          alert(msg);
          return;
        }

        alert("Evento salvo com sucesso!");
        cancelarEdicao();
        listarEventos();
      } catch (error) {
        console.error("Erro ao salvar evento:", error);
      }
    }

    // ======================================
    // üìå CARREGAR EVENTO PARA EDI√á√ÉO
    // ======================================
    async function carregarEvento(id) {
      try {
        const response = await fetch(`${API_URL}/${id}`, {
          headers: { Authorization: "Bearer " + token }
        });
        const equipes = await response.json();
        const ev = equipes.data;

        document.getElementById("evento_id").value = ev.id;
        document.getElementById("nome").value = ev.nome;
        document.getElementById("descricao").value = ev.descricao || "";
        document.getElementById("local").value = ev.local || "";
        document.getElementById("start_date").value = ev.start_date || "";
        document.getElementById("end_date").value = ev.end_date || "";
        document.getElementById("capacity").value = ev.capacity ?? "";
        document.getElementById("valor_encontreiro").value = ev.valor_encontreiro ?? "";
        document.getElementById("valor_encontrista").value = ev.valor_encontrista ?? "";

        document.getElementById("card").style.display = "block";  // Torna o card invis√≠vel

        document.getElementById("btn-cancelar").style.display = "inline-block";
      } catch (error) {
        console.error("Erro ao carregar evento:", error);
      }
    }

    // ======================================
    // üìå CANCELAR EDI√á√ÉO
    // ======================================
    function cancelarEdicao() {
      document.getElementById("evento_id").value = "";
      document.getElementById("form-evento").reset();
      document.getElementById("btn-cancelar").style.display = "none";
      const cardEvento = document.getElementById("card");
      cardEvento.style.display = "none";  // Torna o card invis√≠vel

      // Exibe novamente o bot√£o de cadastrar evento
      const btnCadastrar = document.querySelector("button[onclick='mostrarCardEvento()']");
      btnCadastrar.style.display = "inline-block";  // Exibe o bot√£o "Cadastrar Evento" novamente
      document.getElementById("form-evento").reset();  // Reseta o formul√°rio
      document.getElementById("btn-cancelar").style.display = "none";  // Oculta o bot√£o "Cancelar"
    }

    // Fun√ß√£o para exibir o card de cria√ß√£o/edi√ß√£o
    function mostrarCardEvento() {
      document.getElementById("card").style.display = "block";  // Torna o card vis√≠vel
      // Oculta o bot√£o de cadastrar
      const btnCadastrar = document.querySelector("button[onclick='mostrarCardEvento()']");
      btnCadastrar.style.display = "none";
      document.getElementById("btn-cancelar").style.display = "block";  // Oculta o bot√£o "Cancelar"

    }


    // ======================================
    // üìå DELETAR EVENTO
    // ======================================
    async function deletarEvento(id) {
      if (!confirm("Tem certeza que deseja excluir este evento?")) return;

      try {
        const response = await fetch(`${API_URL}/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token }
        });

        if (!response.ok) {
          alert("Erro ao excluir evento");
          return;
        }

        listarEventos();
      } catch (error) {
        console.error("Erro ao excluir evento:", error);
      }
    }

    // ‚ñ∂ Inicializa listagem
    withLoader(() => listarEventos());
  </script>

</body>

</html>