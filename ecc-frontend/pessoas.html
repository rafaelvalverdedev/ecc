<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes â€¢ ECC</title>
  <link rel="stylesheet" href="estilos.css">
</head>

<body>

  <button class="logout-btn" onclick="logout()">Sair</button>
  <br><br>

  <!-- NavegaÃ§Ã£o -->
  <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
  <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
  <button class="nav-btn" onclick="goTo('equipes_evento')">Evento x Equipe</button>
  <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
  <button class="nav-btn" onclick="goTo('inscricoes')">InscriÃ§Ãµes</button>
  <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>



  <h1>Gerenciar Pessoas</h1>

  <div class="card">
    <h2>Pessoas cadastradas</h2>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Telefone</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="lista-pessoas"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Criar / Editar Pessoa</h2>

    <form id="formPessoa" onsubmit="salvarPessoa(event)">
      <input type="hidden" id="pessoa_id">

      <label>Nome:</label>
      <input id="nome" required>

      <label>Email:</label>
      <input id="email" type="email">

      <label>Telefone:</label>
      <input id="telefone">

      <button type="submit" id="btnSalvar">Salvar</button>
      <button type="button" id="btnCancelar" onclick="cancelarEdicao()" style="display:none;">Cancelar</button>
    </form>
  </div>
  <script>
    // ============================
    // ðŸ” AUTENTICAÃ‡ÃƒO
    // ============================
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));

    if (!token) {
      window.location.href = "./auth-login.html";
    }

    // ============================
    // ðŸ”“ Logout
    // ============================
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "./auth-login.html";
    }

    // ============================
    // ðŸ”„ NavegaÃ§Ã£o
    // ============================
    function goTo(page) {
      window.location.href = `./${page}.html`;
    }

    const API_URL = "http://localhost:3001/pessoas";

    // ============================
    // ðŸ“Œ LISTAR PESSOAS
    // ============================
    async function listarPessoas() {
      const res = await fetch(API_URL, {
        headers: { Authorization: "Bearer " + token }
      });

      const pessoas = await res.json();
      const tbody = document.getElementById("lista-pessoas");
      tbody.innerHTML = "";

      pessoas.forEach(p => {
        tbody.innerHTML += `
        <tr>
          <td>${p.nome}</td>
          <td>${p.email ?? "-"}</td>
          <td>${p.telefone ?? "-"}</td>
          <td>
            <button onclick="editarPessoa('${p.id}')">Editar</button>
            <button onclick="excluirPessoa('${p.id}')">Excluir</button>
          </td>
        </tr>
      `;
      });
    }

    // ============================
    // ðŸ“Œ SALVAR (CRIAR OU EDITAR)
    // ============================
    async function salvarPessoa(event) {
      event.preventDefault();

      const id = document.getElementById("pessoa_id").value;
      const payload = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        telefone: document.getElementById("telefone").value
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `${API_URL}/${id}` : API_URL;

      const res = await fetch(url, {
        method,
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let msg = "Erro ao salvar pessoa";
        try {
          const err = await res.json();
          if (err.error) msg = err.error;
        } catch (_) { }
        alert(msg);
        return;
      }

      alert("Pessoa salva!");
      cancelarEdicao();
      listarPessoas();
    }

    // ============================
    // ðŸ“Œ EDITAR
    // ============================
    async function editarPessoa(id) {
      const res = await fetch(`${API_URL}/${id}`, {
        headers: { Authorization: "Bearer " + token }
      });

      const p = await res.json();

      document.getElementById("pessoa_id").value = p.id;
      document.getElementById("nome").value = p.nome;
      document.getElementById("email").value = p.email || "";
      document.getElementById("telefone").value = p.telefone || "";

      document.getElementById("btnCancelar").style.display = "inline-block";
    }

    // ============================
    // ðŸ“Œ CANCELAR EDIÃ‡ÃƒO
    // ============================
    function cancelarEdicao() {
      document.getElementById("pessoa_id").value = "";
      document.getElementById("formPessoa").reset();
      document.getElementById("btnCancelar").style.display = "none";
    }

    // ============================
    // ðŸ“Œ EXCLUIR
    // ============================
    async function excluirPessoa(id) {
      if (!confirm("Excluir esta pessoa?")) return;

      await fetch(`${API_URL}/${id}`, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      });

      listarPessoas();
    }

    // â–¶ INICIAR
    listarPessoas();
  </script>

</body>

</html>