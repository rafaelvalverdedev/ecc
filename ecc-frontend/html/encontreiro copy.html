<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Gerenciar Encontreiro • ECC</title>
    <link rel="stylesheet" href="estilos.css">
</head>

<body>

    <!-- Botão de logout -->
    <button class="logout-btn" onclick="logout()">Sair</button>
    <br><br>

    <!-- Navegação -->
    <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
    <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
    <button class="nav-btn" onclick="goTo('equipes_evento')">Evento x Equipe</button>
    <button class="nav-btn" onclick="goTo('encontreiro')">Encontreiro</button>
    <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
    <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>
    <button class="nav-btn" onclick="goTo('inscricoes')">Inscrições</button>

    <main>
        <!-- Lista de encontreiro geral (somente pessoas, sem regras) -->
        <section class="card">
            <div class="card-geral">
                <h2>Encontreiro Geral</h2>
                <span class="muted">Todas as pessoas cadastradas (sem vínculo específico)</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbody-encontreiro-geral">
                    <!-- preenchido via JS -->
                </tbody>
            </table>

            <div id="lista-feedback-geral" class="muted"></div>
        </section>

        <!-- Lista de encontreiro com vínculo (TeamRole) -->
        <section class="card">
            <div class="card-header">
                <h2>Encontreiro Inscritos</h2>
                <span class="muted">Pessoa + Evento + Equipe + Regras</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Evento</th>
                        <th>Equipe</th>
                        <th>Regras</th>
                        <th>Pagou?</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbody-encontreiro">
                    <!-- preenchido via JS -->
                </tbody>
            </table>

            <div id="lista-feedback" class="muted"></div>
        </section>

        <!-- Cadastro de encontreiro (Pessoa + TeamRole) -->
        <section class="card" id="sec-cadastro">
            <div class="card-header">
                <h2>Cadastrar Encontreiro</h2>
                <span class="muted">Cria a pessoa e o vínculo com evento + equipe</span>
            </div>

            <form id="form-cadastro">
                <div class="row">
                    <div>
                        <label for="nome">Nome</label>
                        <input id="nome" required />
                    </div>
                    <div>
                        <label for="email">E-mail</label>
                        <input id="email" type="email" />
                    </div>
                    <div>
                        <label for="telefone">Telefone</label>
                        <input id="telefone" />
                    </div>
                </div>

                <div class="row">
                    <div>
                        <label for="evento_id">Evento</label>
                        <select id="evento_id" required></select>
                    </div>
                    <div>
                        <label for="equipe_id">Equipe</label>
                        <select id="equipe_id" required></select>
                    </div>
                    <div>
                        <label for="is_leader">
                            <input id="is_leader" type="checkbox" />
                            Coordenador / Líder de Equipe
                        </label>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="primary">Salvar Encontreiro</button>
                </div>

                <div id="cadastro-feedback" class="muted"></div>
            </form>
        </section>

        <!-- Edição (modo pessoa OU modo teamrole) -->
        <section id="sec-edicao" class="card hidden">
            <div class="card-header">
                <h2 id="titulo-edicao">Editar Encontreiro</h2>
                <button type="button" class="secondary" id="btn-cancelar-edicao">
                    Cancelar edição
                </button>
            </div>

            <form id="form-edicao">
                <!-- hidden ids -->
                <input type="hidden" id="edit_teamrole_id" />
                <input type="hidden" id="edit_pessoa_id" />

                <!-- Bloco: dados da pessoa (sempre usado) -->
                <h3>Dados do encontreiro</h3>
                <div class="row">
                    <div>
                        <label for="edit_nome">Nome</label>
                        <input id="edit_nome" required />
                    </div>
                    <div>
                        <label for="edit_email">E-mail</label>
                        <input id="edit_email" type="email" />
                    </div>
                    <div>
                        <label for="edit_telefone">Telefone</label>
                        <input id="edit_telefone" />
                    </div>
                </div>

                <!-- Bloco: regras de vínculo (somente quando editar TeamRole) -->
                <div id="bloco-regras">
                    <h3>Regras de vínculo</h3>
                    <div class="row">
                        <div>
                            <label for="edit_evento_id">Evento</label>
                            <select id="edit_evento_id"></select>
                        </div>
                        <div>
                            <label for="edit_equipe_id">Equipe</label>
                            <select id="edit_equipe_id"></select>
                        </div>
                        <div>
                            <label for="edit_is_leader">
                                <input id="edit_is_leader" type="checkbox" />
                                Coordenador / Líder
                            </label>
                            <br />
                            <label for="edit_pagou">
                                <input id="edit_pagou" type="checkbox" />
                                Pagou
                            </label>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="primary">Salvar alterações</button>
                </div>

                <div id="edicao-feedback" class="muted"></div>
            </form>
        </section>
    </main>

    <script>
        // ==========================
        // CONFIG
        // ==========================
        const API_BASE_URL = "https://ecc-backend-8i9l.onrender.com";
        const API_PESSOAS = API_BASE_URL + "/pessoas";
        const API_EVENTOS = API_BASE_URL + "/eventos";
        const API_EQUIPES = API_BASE_URL + "/equipes";
        const API_TEAMROLE = API_BASE_URL + "/teamrole";

        const token = localStorage.getItem("token");
        if (!token) {
            alert("Sessão expirada. Faça login novamente.");
            window.location.href = "login.html";
        }

        function authHeaders() {
            return {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
            };
        }

        // ==========================
        // LOGOUT E NAVEGAÇÃO
        // ==========================
        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "./auth-login.html";
        }

        function goTo(page) {
            window.location.href = `./${page}.html`;
        }

        // ==========================
        // ELEMENTOS
        // ==========================
        const tbodyEncontreiro = document.getElementById("tbody-encontreiro");
        const tbodyEncontreiroGeral = document.getElementById("tbody-encontreiro-geral");
        const cadastroFeedback = document.getElementById("cadastro-feedback");
        const listaFeedback = document.getElementById("lista-feedback");
        const listaFeedbackGeral = document.getElementById("lista-feedback-geral");
        const secEdicao = document.getElementById("sec-edicao");
        const secCadastro = document.getElementById("sec-cadastro");
        const edicaoFeedback = document.getElementById("edicao-feedback");
        const tituloEdicao = document.getElementById("titulo-edicao");
        const blocoRegras = document.getElementById("bloco-regras");

        const formCadastro = document.getElementById("form-cadastro");
        const formEdicao = document.getElementById("form-edicao");
        const btnCancelarEdicao = document.getElementById("btn-cancelar-edicao");

        // selects cadastro
        const selectEvento = document.getElementById("evento_id");
        const selectEquipe = document.getElementById("equipe_id");

        // selects edição
        const selectEditEvento = document.getElementById("edit_evento_id");
        const selectEditEquipe = document.getElementById("edit_equipe_id");

        // inputs edição
        const editTeamroleId = document.getElementById("edit_teamrole_id");
        const editPessoaId = document.getElementById("edit_pessoa_id");
        const editNome = document.getElementById("edit_nome");
        const editEmail = document.getElementById("edit_email");
        const editTelefone = document.getElementById("edit_telefone");
        const editIsLeader = document.getElementById("edit_is_leader");
        const editPagou = document.getElementById("edit_pagou");

        // Modo de edição: "none" | "pessoa" | "teamrole"
        const EDIT_MODE = {
            NONE: "none",
            PESSOA: "pessoa",
            TEAMROLE: "teamrole",
        };
        let editMode = EDIT_MODE.NONE;

        // ==========================
        // CARREGAR EVENTOS E EQUIPES
        // ==========================
        async function carregarEventosEEquipes() {
            try {
                const [eventosRes, equipesRes] = await Promise.all([
                    fetch(API_EVENTOS, { headers: authHeaders() }).then((r) => r.json()),
                    fetch(API_EQUIPES, { headers: authHeaders() }).then((r) => r.json()),
                ]);

                const eventos = eventosRes.data || [];
                const equipes = equipesRes.data || [];

                // limpar
                selectEvento.innerHTML = '<option value="">Selecione</option>';
                selectEditEvento.innerHTML = '<option value="">Selecione</option>';
                selectEquipe.innerHTML = '<option value="">Selecione</option>';
                selectEditEquipe.innerHTML = '<option value="">Selecione</option>';

                eventos.forEach((ev) => {
                    const opt1 = document.createElement("option");
                    opt1.value = ev.id;
                    opt1.textContent = ev.nome;
                    selectEvento.appendChild(opt1);

                    const opt2 = document.createElement("option");
                    opt2.value = ev.id;
                    opt2.textContent = ev.nome;
                    selectEditEvento.appendChild(opt2);
                });

                equipes.forEach((eq) => {
                    const opt1 = document.createElement("option");
                    opt1.value = eq.id;
                    opt1.textContent = eq.nome;
                    selectEquipe.appendChild(opt1);

                    const opt2 = document.createElement("option");
                    opt2.value = eq.id;
                    opt2.textContent = eq.nome;
                    selectEditEquipe.appendChild(opt2);
                });
            } catch (err) {
                console.error("Erro ao carregar eventos/equipes:", err);
            }
        }

        // ==========================
        // LISTAR ENCONTREIRO GERAL (PESSOAS)
        // ==========================
        async function carregarEncontreiroGeral() {
            listaFeedbackGeral.textContent = "Carregando...";
            tbodyEncontreiroGeral.innerHTML = "";

            try {
                const resGeral = await fetch(API_PESSOAS, { headers: authHeaders() });
                const jsonGeral = await resGeral.json();
                const listaGeral = jsonGeral.data || [];

                // Ignorar pessoas com role = admin
                const listaFiltrada = listaGeral.filter((p) => p.role !== "admin");

                if (!listaFiltrada.length) {
                    listaFeedbackGeral.textContent = "Nenhum encontreiro cadastrado.";
                    return;
                }

                listaFeedbackGeral.textContent = "";

                listaFiltrada.forEach((p) => {
                    const trEl = document.createElement("tr");

                    const nome = p.nome || "-";
                    const email = p.email || "-";
                    const telefone = p.telefone || "-";

                    trEl.innerHTML = `
                        <td>${nome}</td>
                        <td>${email}</td>
                        <td>${telefone}</td>
                        <td>
                            <button class="secondary btn-editar-pessoa" data-id="${p.id}">Editar</button>
                            <button class="danger btn-excluir-pessoa" data-id="${p.id}">Excluir</button>
                        </td>
                    `;

                    tbodyEncontreiroGeral.appendChild(trEl);
                });

                // Eventos de clique
                tbodyEncontreiroGeral.querySelectorAll(".btn-editar-pessoa").forEach((btn) => {
                    btn.addEventListener("click", () => abrirEdicaoPessoa(btn.dataset.id));
                });

                tbodyEncontreiroGeral.querySelectorAll(".btn-excluir-pessoa").forEach((btn) => {
                    btn.addEventListener("click", () => excluirEncontreiroGeral(btn.dataset.id));
                });

            } catch (err) {
                console.error("Erro ao carregar encontreiro geral:", err);
                listaFeedbackGeral.textContent = "Erro ao carregar encontreiro.";
            }
        }

        // ==========================
        // LISTAR ENCONTREIROS INSCRITOS (TEAMROLE)
        // ==========================
        async function carregarEncontreiro() {
            listaFeedback.textContent = "Carregando...";
            tbodyEncontreiro.innerHTML = "";

            try {
                const res = await fetch(API_TEAMROLE, { headers: authHeaders() });
                const json = await res.json();
                const lista = json.data || [];

                // Ignorar vínculos cuja pessoa seja admin
                const listaFiltrada = lista.filter((tr) => tr.pessoa?.role !== "admin");

                if (!listaFiltrada.length) {
                    listaFeedback.textContent = "Nenhum encontreiro cadastrado.";
                    return;
                }

                listaFeedback.textContent = "";

                listaFiltrada.forEach((tr) => {
                    const trEl = document.createElement("tr");

                    const nome = tr.pessoa?.nome || "-";
                    const email = tr.pessoa?.email || "-";
                    const telefone = tr.pessoa?.telefone || "-";
                    const eventoNome = tr.evento?.nome || "-";
                    const equipeNome = tr.equipe?.nome || "-";

                    trEl.innerHTML = `
                        <td>${nome}</td>
                        <td>${email}</td>
                        <td>${telefone}</td>
                        <td>${eventoNome}</td>
                        <td>${equipeNome}</td>
                        <td>
                            <span class="badge ${tr.is_leader ? "blue" : "red"}">
                                ${tr.is_leader ? "Coordenador" : "Encontreiro"}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${tr.pagou ? "blue" : "red"}">
                                ${tr.pagou ? "Sim" : "Não"}
                            </span>
                        </td>
                        <td>
                            <button class="secondary btn-editar-tr" data-id="${tr.id}">Editar</button>
                            <button class="danger btn-excluir-tr" data-id="${tr.id}">Excluir</button>
                        </td>
                    `;

                    tbodyEncontreiro.appendChild(trEl);
                });

                // Eventos de clique
                tbodyEncontreiro.querySelectorAll(".btn-editar-tr").forEach((btn) => {
                    btn.addEventListener("click", () => abrirEdicaoTeamrole(btn.dataset.id));
                });

                tbodyEncontreiro.querySelectorAll(".btn-excluir-tr").forEach((btn) => {
                    btn.addEventListener("click", () => excluirEncontreiro(btn.dataset.id));
                });

            } catch (err) {
                console.error("Erro ao carregar encontreiro inscritos:", err);
                listaFeedback.textContent = "Erro ao carregar encontreiro.";
            }
        }

        // ==========================
        // CADASTRAR ENCONTREIRO (PESSOA + TEAMROLE)
        // ==========================
        formCadastro.addEventListener("submit", async (e) => {
            e.preventDefault();
            cadastroFeedback.textContent = "";
            cadastroFeedback.className = "muted";

            const nome = document.getElementById("nome").value.trim();
            const email = document.getElementById("email").value.trim();
            const telefone = document.getElementById("telefone").value.trim();
            const evento_id = selectEvento.value;
            const equipe_id = selectEquipe.value;
            const is_leader = document.getElementById("is_leader").checked;

            if (!nome || !evento_id || !equipe_id) {
                cadastroFeedback.textContent = "Preencha ao menos nome, evento e equipe.";
                cadastroFeedback.className = "error";
                return;
            }

            try {
                // 1) cria pessoa
                const resPessoa = await fetch(API_PESSOAS, {
                    method: "POST",
                    headers: authHeaders(),
                    body: JSON.stringify({ nome, email, telefone }),
                });

                const pessoaJson = await resPessoa.json();

                if (!resPessoa.ok) {
                    console.error(pessoaJson);
                    cadastroFeedback.textContent = pessoaJson.error || "Erro ao criar pessoa.";
                    cadastroFeedback.className = "error";
                    return;
                }

                const pessoa = (pessoaJson.data && pessoaJson.data[0]) || pessoaJson.data || pessoaJson.pessoa;
                const pessoa_id = pessoa.id;

                // 2) cria vínculo teamrole
                const resTR = await fetch(API_TEAMROLE, {
                    method: "POST",
                    headers: authHeaders(),
                    body: JSON.stringify({
                        pessoa_id,
                        evento_id,
                        equipe_id,
                        is_leader,
                        pagou: false,
                    }),
                });

                const trJson = await resTR.json();

                if (!resTR.ok) {
                    console.error(trJson);
                    cadastroFeedback.textContent = trJson.error || "Erro ao criar vínculo.";
                    cadastroFeedback.className = "error";
                    return;
                }

                cadastroFeedback.textContent = "Encontreiro cadastrado com sucesso.";
                cadastroFeedback.className = "success";

                formCadastro.reset();
                await carregarEventosEEquipes();
                await carregarEncontreiro();
                await carregarEncontreiroGeral();
            } catch (err) {
                console.error(err);
                cadastroFeedback.textContent = "Erro inesperado ao cadastrar.";
                cadastroFeedback.className = "error";
            }
        });

        // ==========================
        // ABRIR EDIÇÃO: PESSOA (LISTA GERAL)
        // ==========================
        async function abrirEdicaoPessoa(id) {
            edicaoFeedback.textContent = "";
            edicaoFeedback.className = "muted";
            editMode = EDIT_MODE.PESSOA;

            // Ajustar UI
            tituloEdicao.textContent = "Editar Encontreiro (dados pessoais)";
            blocoRegras.classList.add("hidden"); // esconde regras
            secEdicao.classList.remove("hidden");
            secCadastro.classList.add("hidden");

            try {
                const res = await fetch(`${API_PESSOAS}/${id}`, { headers: authHeaders() });
                const json = await res.json();

                if (!res.ok) {
                    console.error(json);
                    alert(json.error || "Erro ao buscar encontreiro.");
                    return;
                }

                const p = json.data || json.pessoa || json;

                editTeamroleId.value = ""; // sem vínculo aqui
                editPessoaId.value = p.id;
                editNome.value = p.nome || "";
                editEmail.value = p.email || "";
                editTelefone.value = p.telefone || "";

                secEdicao.scrollIntoView({ behavior: "smooth" });
            } catch (err) {
                console.error(err);
                alert("Erro ao abrir edição do encontreiro.");
            }
        }

        // ==========================
        // ABRIR EDIÇÃO: TEAMROLE (INSCRITOS)
        // ==========================
        async function abrirEdicaoTeamrole(id) {
            edicaoFeedback.textContent = "";
            edicaoFeedback.className = "muted";
            editMode = EDIT_MODE.TEAMROLE;

            // Ajustar UI
            tituloEdicao.textContent = "Editar Encontreiro & Vínculo";
            blocoRegras.classList.remove("hidden"); // mostra regras
            secEdicao.classList.remove("hidden");
            secCadastro.classList.add("hidden");

            try {
                const res = await fetch(`${API_TEAMROLE}/${id}`, { headers: authHeaders() });
                const json = await res.json();

                if (!res.ok) {
                    console.error(json);
                    alert(json.error || "Erro ao buscar encontreiro.");
                    return;
                }

                const tr = json.data || json;

                editTeamroleId.value = tr.id;
                editPessoaId.value = tr.pessoa.id;
                editNome.value = tr.pessoa.nome || "";
                editEmail.value = tr.pessoa.email || "";
                editTelefone.value = tr.pessoa.telefone || "";

                selectEditEvento.value = tr.evento?.id || "";
                selectEditEquipe.value = tr.equipe?.id || "";
                editIsLeader.checked = !!tr.is_leader;
                editPagou.checked = !!tr.pagou;

                secEdicao.scrollIntoView({ behavior: "smooth" });
            } catch (err) {
                console.error(err);
                alert("Erro ao abrir edição.");
            }
        }

        // ==========================
        // SALVAR EDIÇÃO (PESSOA ou TEAMROLE)
        // ==========================
        formEdicao.addEventListener("submit", async (e) => {
            e.preventDefault();
            edicaoFeedback.textContent = "";
            edicaoFeedback.className = "muted";

            const teamrole_id = editTeamroleId.value;
            const pessoa_id = editPessoaId.value;

            const nome = editNome.value.trim();
            const email = editEmail.value.trim();
            const telefone = editTelefone.value.trim();
            const evento_id = selectEditEvento.value;
            const equipe_id = selectEditEquipe.value;
            const is_leader = editIsLeader.checked;
            const pagou = editPagou.checked;

            if (!pessoa_id) {
                edicaoFeedback.textContent = "Registro inválido de pessoa.";
                edicaoFeedback.className = "error";
                return;
            }

            if (!nome) {
                edicaoFeedback.textContent = "O nome do encontreiro é obrigatório.";
                edicaoFeedback.className = "error";
                return;
            }

            try {
                // 1) Atualiza pessoa (sempre que estiver em edição)
                const resPessoa = await fetch(`${API_PESSOAS}/${pessoa_id}`, {
                    method: "PUT",
                    headers: authHeaders(),
                    body: JSON.stringify({ nome, email, telefone }),
                });

                const pessoaJson = await resPessoa.json();
                if (!resPessoa.ok) {
                    console.error(pessoaJson);
                    edicaoFeedback.textContent = pessoaJson.error || "Erro ao atualizar pessoa.";
                    edicaoFeedback.className = "error";
                    return;
                }

                // 2) Se for edição de TEAMROLE, também atualiza vínculo
                if (editMode === EDIT_MODE.TEAMROLE) {
                    if (!teamrole_id) {
                        edicaoFeedback.textContent = "Registro de vínculo inválido.";
                        edicaoFeedback.className = "error";
                        return;
                    }

                    if (!evento_id || !equipe_id) {
                        edicaoFeedback.textContent = "Selecione evento e equipe.";
                        edicaoFeedback.className = "error";
                        return;
                    }

                    const resTR = await fetch(`${API_TEAMROLE}/${teamrole_id}`, {
                        method: "PUT",
                        headers: authHeaders(),
                        body: JSON.stringify({
                            evento_id,
                            equipe_id,
                            is_leader,
                            pagou,
                        }),
                    });

                    const trJson = await resTR.json();
                    if (!resTR.ok) {
                        console.error(trJson);
                        edicaoFeedback.textContent = trJson.error || "Erro ao atualizar vínculo.";
                        edicaoFeedback.className = "error";
                        return;
                    }
                }

                edicaoFeedback.textContent = "Encontreiro atualizado com sucesso.";
                edicaoFeedback.className = "success";

                await carregarEventosEEquipes();
                await carregarEncontreiro();
                await carregarEncontreiroGeral();
            } catch (err) {
                console.error(err);
                edicaoFeedback.textContent = "Erro inesperado ao salvar.";
                edicaoFeedback.className = "error";
            }
        });

        // Cancelar edição
        btnCancelarEdicao.addEventListener("click", () => {
            secEdicao.classList.add("hidden");
            secCadastro.classList.remove("hidden");
            edicaoFeedback.textContent = "";
            edicaoFeedback.className = "muted";
            editMode = EDIT_MODE.NONE;
        });

        // ==========================
        // EXCLUIR ENCONTREIRO INSCRITO (TEAMROLE)
        // ==========================
        async function excluirEncontreiro(id) {
            if (!confirm("Deseja realmente excluir este vínculo de encontreiro?")) return;

            try {
                const res = await fetch(`${API_TEAMROLE}/${id}`, {
                    method: "DELETE",
                    headers: authHeaders(),
                });

                const json = await res.json().catch(() => ({}));

                if (!res.ok) {
                    console.error(json);
                    alert(json.error || "Erro ao excluir vínculo.");
                    return;
                }

                await carregarEventosEEquipes();
                await carregarEncontreiro();
                await carregarEncontreiroGeral();
            } catch (err) {
                console.error(err);
                alert("Erro inesperado ao excluir.");
            }
        }

        // ==========================
        // EXCLUIR ENCONTREIRO GERAL (PESSOA)
        // ==========================
        async function excluirEncontreiroGeral(id) {
            if (!confirm("Deseja realmente excluir esta pessoa (encontreiro geral)?")) return;

            try {
                const res = await fetch(`${API_PESSOAS}/${id}`, {
                    method: "DELETE",
                    headers: authHeaders(),
                });

                const json = await res.json().catch(() => ({}));

                if (!res.ok) {
                    console.error(json);
                    alert(json.error || "Erro ao excluir pessoa.");
                    return;
                }

                await carregarEventosEEquipes();
                await carregarEncontreiro();
                await carregarEncontreiroGeral();
            } catch (err) {
                console.error(err);
                alert("Erro inesperado ao excluir.");
            }
        }

        // ==========================
        // INICIALIZAÇÃO
        // ==========================
        (async function init() {
            await carregarEventosEEquipes();
            await carregarEncontreiro();
            await carregarEncontreiroGeral();
        })();
    </script>
</body>

</html>
