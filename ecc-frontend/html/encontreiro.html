<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Gerenciar Encontreiro • ECC</title>
    <link rel="stylesheet" href="estilos.css">
</head>

<body>

    <!-- Botão de logout -->
    <button class="logout-btn" onclick="logout()">Sair</button>
    <br><br>

    <!-- Navegação -->
    <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
    <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
    <button class="nav-btn" onclick="goTo('equipes_evento')">Evento x Equipe</button>
    <button class="nav-btn" onclick="goTo('encontreiro')">Encontreiro</button>
    <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
    <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>
    <button class="nav-btn" onclick="goTo('inscricoes')">Inscrições</button>

    <main>

        <!-- Lista de encontreiro geral (somente pessoas, sem regras) -->
        <section class="card">
            <div class="card-geral">
                <h2>Encontreiro Geral</h2>
                <span class="muted">Todas as pessoas cadastradas (sem vínculo específico)</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbody-encontreiro-geral"></tbody>
            </table>

            <div id="lista-feedback-geral" class="muted"></div>
        </section>

        <!-- Lista de encontreiro com vínculo (TeamRole) -->
        <section class="card">
            <div class="card-header">
                <h2>Encontreiro Inscritos</h2>
                <span class="muted">Pessoa + Evento + Equipe + Regras</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Evento</th>
                        <th>Equipe</th>
                        <th>Regras</th>
                        <th>Pagou?</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbody-encontreiro"></tbody>
            </table>

            <div id="lista-feedback" class="muted"></div>
        </section>

        <!-- Cadastro de encontreiro -->
        <section class="card" id="sec-cadastro">
            <div class="card-header">
                <h2>Cadastrar Encontreiro</h2>
                <span class="muted">Cria a pessoa e o vínculo com evento + equipe</span>
            </div>

            <form id="form-cadastro">
                <div class="row">
                    <div>
                        <label for="nome">Nome</label>
                        <input id="nome" required />
                    </div>
                    <div>
                        <label for="email">E-mail</label>
                        <input id="email" type="email" />
                    </div>
                    <div>
                        <label for="telefone">Telefone</label>
                        <input id="telefone" />
                    </div>
                </div>

                <div class="row">
                    <div>
                        <label for="evento_id">Evento</label>
                        <select id="evento_id" required></select>
                    </div>
                    <div>
                        <label for="equipe_id">Equipe</label>
                        <select id="equipe_id" required></select>
                    </div>
                    <div>
                        <label for="is_leader">
                            <input id="is_leader" type="checkbox" />
                            Coordenador / Líder de Equipe
                        </label>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="primary">Salvar Encontreiro</button>
                </div>

                <div id="cadastro-feedback" class="muted"></div>
            </form>
        </section>

        <!-- Edição -->
        <section id="sec-edicao" class="card hidden">
            <div class="card-header">
                <h2 id="titulo-edicao">Editar Encontreiro</h2>
                <button type="button" class="secondary" id="btn-cancelar-edicao">
                    Cancelar edição
                </button>
            </div>

            <form id="form-edicao">
                <input type="hidden" id="edit_teamrole_id" />
                <input type="hidden" id="edit_pessoa_id" />

                <h3>Dados do encontreiro</h3>

                <div class="row">
                    <div>
                        <label for="edit_nome">Nome</label>
                        <input id="edit_nome" required />
                    </div>
                    <div>
                        <label for="edit_email">E-mail</label>
                        <input id="edit_email" type="email" />
                    </div>
                    <div>
                        <label for="edit_telefone">Telefone</label>
                        <input id="edit_telefone" />
                    </div>
                </div>

                <div id="bloco-regras">
                    <h3>Regras de vínculo</h3>
                    <div class="row">
                        <div>
                            <label for="edit_evento_id">Evento</label>
                            <select id="edit_evento_id"></select>
                        </div>
                        <div>
                            <label for="edit_equipe_id">Equipe</label>
                            <select id="edit_equipe_id"></select>
                        </div>
                        <div>
                            <label>
                                <input id="edit_is_leader" type="checkbox" />
                                Coordenador / Líder
                            </label>
                            <br />
                            <label>
                                <input id="edit_pagou" type="checkbox" />
                                Pagou
                            </label>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="primary">Salvar alterações</button>
                </div>

                <div id="edicao-feedback" class="muted"></div>
            </form>
        </section>
    </main>

    <script src="../config.js"></script>
    <script>
        // =====================================
        // CONFIG
        // =====================================
        const API = APP_CONFIG.API_BASE_URL;

        const API_PESSOAS = API + "/pessoas";
        const API_EVENTOS = API + "/eventos";
        const API_EQUIPES = API + "/equipes";
        const API_TEAMROLE = API + "/teamrole";

        const token = localStorage.getItem("token");
        if (!token) {
            alert("Sessão expirada. Faça login novamente.");
            window.location.href = "login.html";
        }

        function authHeaders() {
            return {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
            };
        }

        // =====================================
        // LOGOUT E NAVEGAÇÃO
        // =====================================
        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "./auth-login.html";
        }

        function goTo(page) {
            window.location.href = `./${page}.html`;
        }

        // =====================================
        // ELEMENTOS
        // =====================================
        const tbodyEncontreiro = document.getElementById("tbody-encontreiro");
        const tbodyEncontreiroGeral = document.getElementById("tbody-encontreiro-geral");

        const cadastroFeedback = document.getElementById("cadastro-feedback");
        const listaFeedback = document.getElementById("lista-feedback");
        const listaFeedbackGeral = document.getElementById("lista-feedback-geral");

        const secEdicao = document.getElementById("sec-edicao");
        const secCadastro = document.getElementById("sec-cadastro");

        const edicaoFeedback = document.getElementById("edicao-feedback");
        const tituloEdicao = document.getElementById("titulo-edicao");
        const blocoRegras = document.getElementById("bloco-regras");

        const formCadastro = document.getElementById("form-cadastro");
        const formEdicao = document.getElementById("form-edicao");
        const btnCancelarEdicao = document.getElementById("btn-cancelar-edicao");

        // selects cadastro
        const selectEvento = document.getElementById("evento_id");
        const selectEquipe = document.getElementById("equipe_id");

        // selects edição
        const selectEditEvento = document.getElementById("edit_evento_id");
        const selectEditEquipe = document.getElementById("edit_equipe_id");

        // inputs edição
        const editTeamroleId = document.getElementById("edit_teamrole_id");
        const editPessoaId = document.getElementById("edit_pessoa_id");
        const editNome = document.getElementById("edit_nome");
        const editEmail = document.getElementById("edit_email");
        const editTelefone = document.getElementById("edit_telefone");
        const editIsLeader = document.getElementById("edit_is_leader");
        const editPagou = document.getElementById("edit_pagou");

        // Modo de edição
        const EDIT_MODE = { NONE: "none", PESSOA: "pessoa", TEAMROLE: "teamrole" };
        let editMode = EDIT_MODE.NONE;

        // =====================================
        // CARREGAR EVENTOS E EQUIPES
        // =====================================
        async function carregarEventosEEquipes() {
            try {
                const [eventosRes, equipesRes] = await Promise.all([
                    fetch(API_EVENTOS, { headers: authHeaders() }).then(r => r.json()),
                    fetch(API_EQUIPES, { headers: authHeaders() }).then(r => r.json()),
                ]);

                const eventos = eventosRes.data || [];
                const equipes = equipesRes.data || [];

                selectEvento.innerHTML =
                    selectEditEvento.innerHTML =
                    selectEquipe.innerHTML =
                    selectEditEquipe.innerHTML =
                    '<option value="">Selecione</option>';

                eventos.forEach(ev => {
                    selectEvento.innerHTML += `<option value="${ev.id}">${ev.nome}</option>`;
                    selectEditEvento.innerHTML += `<option value="${ev.id}">${ev.nome}</option>`;
                });

                equipes.forEach(eq => {
                    selectEquipe.innerHTML += `<option value="${eq.id}">${eq.nome}</option>`;
                    selectEditEquipe.innerHTML += `<option value="${eq.id}">${eq.nome}</option>`;
                });

            } catch (err) {
                console.error("Erro ao carregar eventos/equipes:", err);
            }
        }

        // =====================================
        // LISTAR ENCONTREIRO GERAL
        // =====================================
        async function carregarEncontreiroGeral() {
            listaFeedbackGeral.textContent = "Carregando...";
            tbodyEncontreiroGeral.innerHTML = "";

            try {
                const resGeral = await fetch(API_PESSOAS, { headers: authHeaders() });
                const jsonGeral = await resGeral.json();
                const lista = (jsonGeral.data || []).filter(p => p.role !== "admin");

                if (!lista.length) {
                    listaFeedbackGeral.textContent = "Nenhum encontreiro cadastrado.";
                    return;
                }

                listaFeedbackGeral.textContent = "";

                lista.forEach(p => {
                    tbodyEncontreiroGeral.innerHTML += `
                        <tr>
                            <td>${p.nome || "-"}</td>
                            <td>${p.email || "-"}</td>
                            <td>${p.telefone || "-"}</td>
                            <td>
                                <button class="secondary btn-editar-pessoa" data-id="${p.id}">Editar</button>
                                <button class="danger btn-excluir-pessoa" data-id="${p.id}">Excluir</button>
                            </td>
                        </tr>
                    `;
                });

                tbodyEncontreiroGeral.querySelectorAll(".btn-editar-pessoa").forEach(btn => {
                    btn.addEventListener("click", () => abrirEdicaoPessoa(btn.dataset.id));
                });

                tbodyEncontreiroGeral.querySelectorAll(".btn-excluir-pessoa").forEach(btn => {
                    btn.addEventListener("click", () => excluirEncontreiroGeral(btn.dataset.id));
                });

            } catch (err) {
                console.error("Erro ao carregar encontreiro geral:", err);
                listaFeedbackGeral.textContent = "Erro ao carregar.";
            }
        }

        // =====================================
        // LISTAR ENCONTREIRO COM VÍNCULO
        // =====================================
        async function carregarEncontreiro() {
            listaFeedback.textContent = "Carregando...";
            tbodyEncontreiro.innerHTML = "";

            try {
                const res = await fetch(API_TEAMROLE, { headers: authHeaders() });
                const json = await res.json();

                const lista = (json.data || []).filter(tr => tr.pessoa?.role !== "admin");

                if (!lista.length) {
                    listaFeedback.textContent = "Nenhum encontreiro inscrito.";
                    return;
                }

                listaFeedback.textContent = "";

                lista.forEach(tr => {
                    tbodyEncontreiro.innerHTML += `
                        <tr>
                            <td>${tr.pessoa?.nome || "-"}</td>
                            <td>${tr.pessoa?.email || "-"}</td>
                            <td>${tr.pessoa?.telefone || "-"}</td>
                            <td>${tr.evento?.nome || "-"}</td>
                            <td>${tr.equipe?.nome || "-"}</td>

                            <td>
                                <span class="badge ${tr.is_leader ? "blue" : "red"}">
                                    ${tr.is_leader ? "Coordenador" : "Encontreiro"}
                                </span>
                            </td>

                            <td>
                                ${tr.pagou
                            ? `<span class="badge bg-primary">Sim</span>`
                            : `
                                      <span class="badge bg-danger">
                                        Não ${tr.evento?.valor_encontreiro}
                                      </span>
                                      <button onclick="gerarPagamento('${tr.id}', '${tr.pessoa?.nome}')"
                                              class="btn btn-sm btn-light ms-2">
                                          Gerar Pagamento
                                      </button>
                                    `}
                            </td>

                            <td>
                                <button class="secondary btn-editar-tr" data-id="${tr.id}">Editar</button>
                                <button class="danger btn-excluir-tr" data-id="${tr.id}">Excluir</button>
                            </td>
                        </tr>
                    `;
                });

                tbodyEncontreiro.querySelectorAll(".btn-editar-tr").forEach(btn => {
                    btn.addEventListener("click", () => abrirEdicaoTeamrole(btn.dataset.id));
                });

                tbodyEncontreiro.querySelectorAll(".btn-excluir-tr").forEach(btn => {
                    btn.addEventListener("click", () => excluirEncontreiro(btn.dataset.id));
                });

            } catch (err) {
                console.error("Erro ao carregar encontreiros inscritos:", err);
                listaFeedback.textContent = "Erro ao carregar.";
            }
        }

        // =====================================
        // CADASTRAR ENCONTREIRO
        // =====================================
        formCadastro.addEventListener("submit", async e => {
            e.preventDefault();
            cadastroFeedback.textContent = "";

            const nome = document.getElementById("nome").value.trim();
            const email = document.getElementById("email").value.trim();
            const telefone = document.getElementById("telefone").value.trim();
            const evento_id = selectEvento.value;
            const equipe_id = selectEquipe.value;
            const is_leader = document.getElementById("is_leader").checked;

            if (!nome || !evento_id || !equipe_id) {
                cadastroFeedback.textContent = "Preencha nome, evento e equipe.";
                cadastroFeedback.className = "error";
                return;
            }

            try {
                // 1) Criar pessoa
                const resPessoa = await fetch(API_PESSOAS, {
                    method: "POST",
                    headers: authHeaders(),
                    body: JSON.stringify({ nome, email, telefone }),
                });

                const pessoaJson = await resPessoa.json();
                if (!resPessoa.ok) {
                    cadastroFeedback.textContent = pessoaJson.error;
                    cadastroFeedback.className = "error";
                    return;
                }

                const pessoa = pessoaJson.data;
                const pessoa_id = pessoa.id;

                // 2) Criar vínculo teamrole
                const resTR = await fetch(API_TEAMROLE, {
                    method: "POST",
                    headers: authHeaders(),
                    body: JSON.stringify({
                        pessoa_id,
                        evento_id,
                        equipe_id,
                        is_leader,
                        pagou: false,
                    }),
                });

                const trJson = await resTR.json();
                if (!resTR.ok) {
                    cadastroFeedback.textContent = trJson.error;
                    cadastroFeedback.className = "error";
                    return;
                }

                cadastroFeedback.textContent = "Encontreiro cadastrado com sucesso.";
                cadastroFeedback.className = "success";

                formCadastro.reset();

                await carregarEventosEEquipes();
                await carregarEncontreiro();
                await carregarEncontreiroGeral();

            } catch (err) {
                cadastroFeedback.textContent = "Erro ao cadastrar.";
                cadastroFeedback.className = "error";
            }
        });

        // =====================================
        // ABRIR EDIÇÃO: PESSOA
        // =====================================
        async function abrirEdicaoPessoa(id) {
            editMode = EDIT_MODE.PESSOA;
            tituloEdicao.textContent = "Editar Encontreiro (Dados Pessoais)";
            blocoRegras.classList.add("hidden");

            secEdicao.classList.remove("hidden");
            secCadastro.classList.add("hidden");

            try {
                const res = await fetch(`${API_PESSOAS}/${id}`, { headers: authHeaders() });
                const json = await res.json();

                const p = json.data;

                editPessoaId.value = p.id;
                editNome.value = p.nome;
                editEmail.value = p.email || "";
                editTelefone.value = p.telefone || "";

            } catch (err) {
                alert("Erro ao abrir edição.");
            }
        }

        // =====================================
        // ABRIR EDIÇÃO: TEAMROLE
        // =====================================
        async function abrirEdicaoTeamrole(id) {
            editMode = EDIT_MODE.TEAMROLE;
            tituloEdicao.textContent = "Editar Encontreiro & Vínculo";

            blocoRegras.classList.remove("hidden");

            secEdicao.classList.remove("hidden");
            secCadastro.classList.add("hidden");

            try {
                const res = await fetch(`${API_TEAMROLE}/${id}`, { headers: authHeaders() });
                const json = await res.json();

                const tr = json.data;

                editTeamroleId.value = tr.id;
                editPessoaId.value = tr.pessoa.id;

                editNome.value = tr.pessoa.nome;
                editEmail.value = tr.pessoa.email || "";
                editTelefone.value = tr.pessoa.telefone || "";

                selectEditEvento.value = tr.evento.id;
                selectEditEquipe.value = tr.equipe.id;

                editIsLeader.checked = tr.is_leader;
                editPagou.checked = tr.pagou;

            } catch (err) {
                alert("Erro ao abrir edição.");
            }
        }

        // =====================================
        // SALVAR EDIÇÃO
        // =====================================
        formEdicao.addEventListener("submit", async e => {
            e.preventDefault();

            const pessoa_id = editPessoaId.value;
            const teamrole_id = editTeamroleId.value;

            const nome = editNome.value.trim();
            const email = editEmail.value.trim();
            const telefone = editTelefone.value.trim();

            const evento_id = selectEditEvento.value;
            const equipe_id = selectEditEquipe.value;
            const is_leader = editIsLeader.checked;
            const pagou = editPagou.checked;

            try {
                // Atualiza pessoa
                await fetch(`${API_PESSOAS}/${pessoa_id}`, {
                    method: "PUT",
                    headers: authHeaders(),
                    body: JSON.stringify({ nome, email, telefone }),
                });

                // Atualiza vínculo (teamrole)
                if (editMode === EDIT_MODE.TEAMROLE) {
                    await fetch(`${API_TEAMROLE}/${teamrole_id}`, {
                        method: "PUT",
                        headers: authHeaders(),
                        body: JSON.stringify({
                            evento_id,
                            equipe_id,
                            is_leader,
                            pagou
                        }),
                    });
                }

                edicaoFeedback.textContent = "Salvo com sucesso.";
                edicaoFeedback.className = "success";

                await carregarEncontreiro();
                await carregarEncontreiroGeral();

            } catch (err) {
                edicaoFeedback.textContent = "Erro ao salvar.";
                edicaoFeedback.className = "error";
            }
        });

        btnCancelarEdicao.addEventListener("click", () => {
            secEdicao.classList.add("hidden");
            secCadastro.classList.remove("hidden");
            editMode = EDIT_MODE.NONE;
        });

        // =====================================
        // EXCLUIR TEAMROLE
        // =====================================
        async function excluirEncontreiro(id) {
            if (!confirm("Excluir vínculo do encontreiro?")) return;

            await fetch(`${API_TEAMROLE}/${id}`, {
                method: "DELETE",
                headers: authHeaders(),
            });

            await carregarEncontreiro();
            await carregarEncontreiroGeral();
        }

        // =====================================
        // EXCLUIR PESSOA
        // =====================================
        async function excluirEncontreiroGeral(id) {
            if (!confirm("Excluir esta pessoa?")) return;

            await fetch(`${API_PESSOAS}/${id}`, {
                method: "DELETE",
                headers: authHeaders(),
            });

            await carregarEncontreiro();
            await carregarEncontreiroGeral();
        }

        // ======================================================
        // GERAR PAGAMENTO DO ENCONTREIRO (ATUALIZADO)
        // ======================================================
        async function gerarPagamento(teamroleId, nome) {
            if (!confirm(`Gerar pagamento PIX para ${nome}?`)) return;

            console.log("id " + teamroleId)
            try {
                const res = await fetch(`${API}/pagamento/encontreiro/${teamroleId}`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                const json = await res.json();

                if (!res.ok) {
                    alert(json.error || "Erro ao gerar pagamento");
                    return;
                }

                const { payment_id } = json;

                // Redireciona para página que exibe QR Code
                window.open(`pagamento_encontreiro.html?teamrole_id=${teamroleId}&payment_id=${payment_id}`, '_blank');

            } catch (err) {
                alert("Erro ao gerar pagamento.");
                console.error(err);
            }
        }

        // =====================================
        // INICIALIZAÇÃO
        // =====================================
        (async function init() {
            await carregarEventosEEquipes();
            await carregarEncontreiro();
            await carregarEncontreiroGeral();
        })();

    </script>
</body>

</html>