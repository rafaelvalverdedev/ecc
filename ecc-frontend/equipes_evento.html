<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Equipes â€¢ ECC</title>
  <link rel="stylesheet" href="estilos.css">
</head>

<body>

  <button class="logout-btn" onclick="logout()">Sair</button>
  <br><br>

  <!-- NavegaÃ§Ã£o -->
  <button class="nav-btn" onclick="goTo('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="goTo('eventos')">Eventos</button>
  <button class="nav-btn" onclick="goTo('equipes')">Equipes</button>
  <button class="nav-btn" onclick="goTo('equipes_evento')">Evento x Equipe</button>
  <button class="nav-btn" onclick="goTo('encontreiro')">Encontreiro</button>
  <button class="nav-btn" onclick="goTo('pessoas')">Pessoas</button>
  <button class="nav-btn" onclick="goTo('pessoa_equipe')">Pessoas x Equipe</button>
  <button class="nav-btn" onclick="goTo('inscricoes')">InscriÃ§Ãµes</button>
  
  <h1>VÃ­nculo Equipe x Evento</h1>

  <div class="card">
    <h2>Eventos cadastrados</h2>

    <table>
      <tbody id="lista-vinculos"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Criar/Atualizar VÃ­nculos</h2>

    <label>Evento:</label>
    <select id="evento_id" onchange="renderizarCheckboxes()" required></select>

    <label>Equipes:</label>
    <div id="checkboxContainer" class="checkbox-list"></div>

    <button onclick="salvarVinculos()">Salvar VÃ­nculos</button>
  </div>



  <script>
    // ============================
    // ðŸ” AutenticaÃ§Ã£o
    // ============================
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "./auth-login.html";

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "./auth-login.html";
    }

    function goTo(page) {
      window.location.href = `./${page}.html`;
    }

    const API_EVENTOS = "http://localhost:3001/eventos";
    const API_EQUIPES = "http://localhost:3001/equipes";
    const API_VINCULOS = "http://localhost:3001/equipe_evento";

    let eventos = [];
    let equipes = [];
    let vinculos = [];

    // CabeÃ§alho padrÃ£o com token
    const authHeaders = {
      Authorization: "Bearer " + token
    };

    // ===========================================
    // 1ï¸âƒ£ CARREGAR EVENTOS, EQUIPES E VÃNCULOS
    // ===========================================
    async function carregarListas() {
      try {
        const eventosRes = await fetch(API_EVENTOS, { headers: authHeaders });
        const equipesRes = await fetch(API_EQUIPES, { headers: authHeaders });
        const vinculosRes = await fetch(API_VINCULOS, { headers: authHeaders });

        eventos = await eventosRes.json();
        equipes = await equipesRes.json();
        vinculos = await vinculosRes.json();

        const eventoSelect = document.getElementById("evento_id");
        eventoSelect.innerHTML = "";

        eventos.forEach(e => {
          eventoSelect.innerHTML += `<option value="${e.id}">${e.nome}</option>`;
        });

        // Se tiver ao menos um evento, renderiza os checkboxes
        if (eventos.length > 0) {
          renderizarCheckboxes();
        }
        listarVinculos();
      } catch (err) {
        console.error("Erro ao carregar listas:", err);
        alert("Erro ao carregar eventos/equipes. Verifique se o backend estÃ¡ rodando e se o token Ã© vÃ¡lido.");
      }
    }

    // ===========================================
    // 2ï¸âƒ£ RENDERIZAR LISTA DE CHECKBOXES
    // ===========================================
    function renderizarCheckboxes() {
      const eventoId = document.getElementById("evento_id").value;
      const container = document.getElementById("checkboxContainer");

      container.innerHTML = "";

      if (!eventoId) return;

      // equipes jÃ¡ vinculadas ao evento selecionado
      const vinculadas = vinculos
        .filter(v => v.evento_id === eventoId)
        .map(v => v.equipe_id);

      equipes.forEach(eq => {
        const marcado = vinculadas.includes(eq.id) ? "checked" : "";

        container.innerHTML += `
        <div class="checkbox-item">
          <input type="checkbox" value="${eq.id}" ${marcado}>
          <label>${eq.nome}</label>
        </div>
      `;
      });
    }

    // ===========================================
    // 3ï¸âƒ£ SALVAR MÃšLTIPLOS VÃNCULOS DE UMA VEZ
    // ===========================================
    async function salvarVinculos() {
      const eventoId = document.getElementById("evento_id").value;
      if (!eventoId) {
        alert("Selecione um evento.");
        return;
      }

      const checkboxes = document.querySelectorAll("#checkboxContainer input[type='checkbox']");
      const selecionadas = [];
      checkboxes.forEach(cb => { if (cb.checked) selecionadas.push(cb.value); });

      // vÃ­nculos que o evento jÃ¡ tem no banco
      const vinculadasAntes = vinculos
        .filter(v => v.evento_id === eventoId)
        .map(v => v.equipe_id);

      // criar = marcadas agora mas nÃ£o estavam antes
      const paraCriar = selecionadas.filter(id => !vinculadasAntes.includes(id));

      // excluir = estavam antes mas nÃ£o estÃ£o mais marcadas
      const paraExcluir = vinculadasAntes.filter(id => !selecionadas.includes(id));

      try {
        // ----- CRIAR NOVOS VÃNCULOS -----
        for (const equipeId of paraCriar) {
          await fetch(API_VINCULOS, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...authHeaders
            },
            body: JSON.stringify({ evento_id: eventoId, equipe_id: equipeId })
          });
        }

        // ----- EXCLUIR VÃNCULOS DESMARCADOS -----
        for (const equipeId of paraExcluir) {
          const vinculo = vinculos.find(v => v.evento_id === eventoId && v.equipe_id === equipeId);
          if (vinculo) {
            await fetch(`${API_VINCULOS}/${vinculo.id}`, {
              method: "DELETE",
              headers: authHeaders
            });
          }
        }

        alert("VÃ­nculos atualizados com sucesso!");

        // recarregar tudo
        await atualizarDados();
      } catch (err) {
        console.error("Erro ao salvar vÃ­nculos:", err);
        alert("Erro ao salvar vÃ­nculos. Veja o console para mais detalhes.");
      }
    }

    // ===========================================
    // 4ï¸âƒ£ ATUALIZAR LISTA COMPLETA
    // ===========================================
    async function atualizarDados() {
      const vinculosRes = await fetch(API_VINCULOS, { headers: authHeaders });
      vinculos = await vinculosRes.json();

      renderizarCheckboxes();
      listarVinculos();
    }

    // ===========================================
    // 5ï¸âƒ£ LISTAR NA TABELA
    // ===========================================
    function listarVinculos() {
      const tbody = document.getElementById("lista-vinculos");
      tbody.innerHTML = "";

      // Agrupar vÃ­nculos por evento
      const grupos = {};

      vinculos.forEach(v => {
        const eventoNome = v.evento?.nome ?? "Sem nome";
        if (!grupos[eventoNome]) grupos[eventoNome] = [];
        grupos[eventoNome].push(v);
      });

      const eventosOrdenados = Object.keys(grupos).sort((a, b) =>
        a.localeCompare(b)
      );

      eventosOrdenados.forEach(eventoNome => {
        const lista = grupos[eventoNome];
        const eventoId = eventoNome.replace(/\s+/g, "_");

        // Linha do evento (CABEÃ‡ALHO)
        tbody.innerHTML += `
      <tr class="grupo-header" data-id="${eventoId}" style="background:#eef;cursor:pointer;font-weight:bold;">
        <td colspan="3">â–¶ ${eventoNome} â€” ${lista.length} equipe(s)</td>
      </tr>
    `;

        // Linhas da equipe (COMEÃ‡AM OCULTAS)
        lista.forEach(v => {
          tbody.innerHTML += `
        <tr class="grupo-linha grupo-${eventoId}" style="display:none;">
          <td>${v.equipe?.nome ?? "-"}</td>
          <td><button onclick="excluirVinculo('${v.id}')">Excluir</button></td>
        </tr>
      `;
        });
      });

      ativarToggle();
    }


    // ===========================================
    // â–¶ TOGGLE GRUPO
    function ativarToggle() {
      document.querySelectorAll(".grupo-header").forEach(header => {
        header.onclick = function () {
          const id = header.dataset.id;
          const linhas = document.querySelectorAll(".grupo-" + id);

          const aberto = linhas[0]?.style.display !== "none";

          // Fecha todos antes
          document.querySelectorAll(".grupo-linha").forEach(l => l.style.display = "none");
          document.querySelectorAll(".grupo-header td").forEach(td => {
            td.innerText = td.innerText.replace("â–¼", "â–¶");
          });

          // Se estava aberto â†’ fechar
          if (aberto) {
            return;
          }

          // Abrir este grupo
          linhas.forEach(l => l.style.display = "table-row");

          // Alterar indicador
          const td = header.querySelector("td");
          td.innerText = td.innerText.replace("â–¶", "â–¼");
        };
      });
    }






    async function excluirVinculo(id) {
      if (!confirm("Deseja realmente excluir este vÃ­nculo?")) return;

      await fetch(`${API_VINCULOS}/${id}`, {
        method: "DELETE",
        headers: authHeaders
      });

      // Recarrega dados e atualiza tela
      await atualizarDados();
    }

    // â–¶ INICIAR
    carregarListas();
  </script>

</body>

</html>